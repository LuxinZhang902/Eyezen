<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blink Detection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
        }
        .log-blink { background: #d4edda; }
        .log-error { background: #f8d7da; }
        .log-info { background: #d1ecf1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Blink Detection Test</h1>
        <p>This tool helps diagnose why blink rate is always 0 in your eye tracking extension.</p>
        
        <div class="status info">
            <strong>Instructions:</strong>
            <ol>
                <li>Load your extension in Chrome</li>
                <li>Open the extension popup</li>
                <li>Enable real-time detection</li>
                <li>Look at this page and blink normally</li>
                <li>Check the console logs and metrics below</li>
            </ol>
        </div>

        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value" id="fatigueScore">0</div>
                <div class="metric-label">Fatigue Score (0-100)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="blinkRate">0</div>
                <div class="metric-label">Blinks per Minute</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="totalBlinks">0</div>
                <div class="metric-label">Total Blinks Detected</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="earValue">0.000</div>
                <div class="metric-label">Current EAR Value</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="perclosValue">0.0</div>
                <div class="metric-label">PERCLOS (%)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="detectionStatus">‚ùå</div>
                <div class="metric-label">Detection Active</div>
            </div>
        </div>

        <div class="status info" style="margin: 20px 0;">
            <strong>üìä Score Breakdown:</strong>
            <div id="scoreBreakdown" style="margin-top: 10px; font-family: monospace;">
                <div>‚Ä¢ Fatigue Score: <span id="scoreDisplay">0 / 100</span></div>
                <div>‚Ä¢ Score Level: <span id="scoreLevel">Normal</span></div>
                <div>‚Ä¢ Last Updated: <span id="lastUpdate">Never</span></div>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <button onclick="startMonitoring()">Start Monitoring</button>
            <button onclick="stopMonitoring()">Stop Monitoring</button>
            <button onclick="clearLogs()">Clear Logs</button>
            <button onclick="testBlink()">Simulate Blink</button>
        </div>

        <h3>üìä Real-time Logs</h3>
        <div class="logs" id="logs">
            <div class="log-entry">Waiting for extension data...</div>
        </div>

        <h3>üîß Troubleshooting Steps</h3>
        <div class="status warning">
            <strong>If blink rate is still 0:</strong>
            <ol>
                <li><strong>Check Console:</strong> Open Chrome DevTools (F12) and look for blink detection logs</li>
                <li><strong>EAR Values:</strong> Ensure EAR values are changing (should be ~0.3 when eyes open, ~0.1 when closed)</li>
                <li><strong>Threshold:</strong> Default blink threshold is 0.2 - adjust if needed</li>
                <li><strong>Timing:</strong> Blinks should last 100-400ms to be detected</li>
                <li><strong>Camera:</strong> Ensure camera has good lighting and clear face visibility</li>
            </ol>
        </div>

        <h3>üéØ Expected Behavior</h3>
        <div class="status success">
            <strong>Normal blink detection should show:</strong>
            <ul>
                <li>EAR values fluctuating between 0.25-0.35 (eyes open) and 0.05-0.15 (eyes closed)</li>
                <li>"üîç Blink detected!" messages in console</li>
                <li>Blink rate between 10-20 blinks per minute for normal users</li>
                <li>Gradual increase in total blinks counter</li>
            </ul>
        </div>
    </div>

    <script>
        let monitoring = false;
        let messageListener = null;
        let totalBlinks = 0;

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        function updateMetric(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function startMonitoring() {
            if (monitoring) return;
            
            monitoring = true;
            updateMetric('detectionStatus', '‚úÖ');
            addLog('Started monitoring extension messages', 'info');
            
            // Listen for messages from extension
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                messageListener = (message, sender, sendResponse) => {
                    if (message.type === 'EYE_METRICS') {
                        const metrics = message.data;
                        
                        // Update all metrics
                        updateMetric('fatigueScore', metrics.fatigueIndex.toFixed(1));
                        updateMetric('blinkRate', metrics.blinkRate.toFixed(1));
                        updateMetric('earValue', metrics.earValue.toFixed(3));
                        updateMetric('perclosValue', metrics.perclosValue.toFixed(1));
                        
                        // Update score breakdown
                        updateScoreBreakdown(metrics.fatigueIndex);
                        
                        // Log comprehensive metrics
                        addLog(`Score: ${metrics.fatigueIndex.toFixed(1)}/100, Blink: ${metrics.blinkRate.toFixed(1)} bpm, EAR: ${metrics.earValue.toFixed(3)}, PERCLOS: ${metrics.perclosValue.toFixed(1)}%`, 
                               metrics.fatigueIndex > 50 ? 'error' : metrics.fatigueIndex > 30 ? 'warning' : 'blink');
                        
                        // Estimate total blinks (rough calculation)
                        const estimatedBlinks = Math.round(metrics.blinkRate * 0.5); // Rough estimate for 30 seconds
                        updateMetric('totalBlinks', estimatedBlinks);
                    }
                };
                chrome.runtime.onMessage.addListener(messageListener);
            } else {
                addLog('Chrome extension API not available - testing in regular webpage', 'warning');
            }
        }

        function stopMonitoring() {
            monitoring = false;
            updateMetric('detectionStatus', '‚ùå');
            addLog('Stopped monitoring', 'info');
            
            if (messageListener && typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.onMessage.removeListener(messageListener);
                messageListener = null;
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div class="log-entry">Logs cleared...</div>';
        }

        function updateScoreBreakdown(score) {
            document.getElementById('scoreDisplay').textContent = `${score.toFixed(1)} / 100`;
            
            let level = 'Normal';
            let color = '#28a745';
            if (score > 70) {
                level = 'High Fatigue';
                color = '#dc3545';
            } else if (score > 50) {
                level = 'Moderate Fatigue';
                color = '#fd7e14';
            } else if (score > 30) {
                level = 'Mild Fatigue';
                color = '#ffc107';
            }
            
            const levelElement = document.getElementById('scoreLevel');
            levelElement.textContent = level;
            levelElement.style.color = color;
            levelElement.style.fontWeight = 'bold';
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function testBlink() {
            // Simulate a blink detection for testing
            totalBlinks++;
            updateMetric('totalBlinks', totalBlinks);
            updateMetric('blinkRate', (totalBlinks * 2).toFixed(1)); // Rough estimate
            
            // Simulate fatigue score
            const simulatedScore = Math.min(100, totalBlinks * 5);
            updateMetric('fatigueScore', simulatedScore.toFixed(1));
            updateScoreBreakdown(simulatedScore);
            
            addLog(`Simulated blink detected! Total: ${totalBlinks}, Score: ${simulatedScore.toFixed(1)}`, 'blink');
        }

        // Auto-start monitoring when page loads
        window.addEventListener('load', () => {
            addLog('Blink detection test page loaded', 'info');
            addLog('Click "Start Monitoring" to begin tracking extension data', 'info');
        });

        // Monitor console for blink detection logs
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            const message = args.join(' ');
            if (message.includes('Blink detected') || message.includes('blink') || message.includes('EAR')) {
                addLog(`Console: ${message}`, 'blink');
            }
            originalConsoleLog.apply(console, args);
        };
    </script>
</body>
</html>