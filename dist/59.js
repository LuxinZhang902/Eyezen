/*! For license information please see 59.js.LICENSE.txt */
"use strict";(self.webpackChunkeyezen_chrome_extension=self.webpackChunkeyezen_chrome_extension||[]).push([[59],{123:(e,t,a)=>{a.r(t),a.d(t,{ChromeStorageService:()=>i,DataMigrationService:()=>s,IndexedDBService:()=>n});var r=a(235);class i{static async initialize(){try{if(!this.isChromeApiAvailable())return void console.warn("Chrome API not available, skipping initialization");if(!await this.getUserData()){const e={settings:r.DEFAULT_SETTINGS,metrics:[],breaks:[],events:[],score:{current:50,daily:50,weekly:50,trend:"stable"},lastUpdated:Date.now()};await this.saveUserData(e)}}catch(e){throw console.error("Failed to initialize storage:",e),new Error("Storage initialization failed")}}static isChromeApiAvailable(){return"undefined"!=typeof chrome&&void 0!==chrome.storage&&void 0!==chrome.storage.local}static async getUserData(){try{return this.isChromeApiAvailable()?(await chrome.storage.local.get([this.STORAGE_KEYS.USER_DATA]))[this.STORAGE_KEYS.USER_DATA]||null:(console.warn("Chrome API not available, returning mock data"),null)}catch(e){return console.error("Failed to get user data:",e),null}}static async saveUserData(e){try{if(!this.isChromeApiAvailable())return void console.warn("Chrome API not available, skipping save");e.lastUpdated=Date.now(),await chrome.storage.local.set({[this.STORAGE_KEYS.USER_DATA]:e})}catch(e){throw console.error("Failed to save user data:",e),new Error("Failed to save user data")}}static async getSettings(){try{const e=await this.getUserData();return e?.settings||r.DEFAULT_SETTINGS}catch(e){return console.error("Failed to get settings:",e),r.DEFAULT_SETTINGS}}static async updateSettings(e){try{const t=await this.getUserData();t&&(t.settings={...t.settings,...e},await this.saveUserData(t))}catch(e){throw console.error("Failed to update settings:",e),new Error("Failed to update settings")}}static async addMetrics(e){try{const t=await this.getUserData();if(t){t.metrics.push(e);const a=t.settings.dataRetention,r=Date.now()-24*a*60*60*1e3;t.metrics=t.metrics.filter(e=>e.timestamp>r),await this.saveUserData(t)}}catch(e){throw console.error("Failed to add metrics:",e),new Error("Failed to add metrics")}}static async getMetrics(e,t){try{const a=await this.getUserData();if(!a)return[];let r=a.metrics;return e&&(r=r.filter(t=>t.timestamp>=e.getTime())),t&&(r=r.filter(e=>e.timestamp<=t.getTime())),r.sort((e,t)=>e.timestamp-t.timestamp)}catch(e){return console.error("Failed to get metrics:",e),[]}}static async addBreakSession(e){try{const t=await this.getUserData();if(t){t.breaks.push(e);const a=t.settings.dataRetention,r=Date.now()-24*a*60*60*1e3;t.breaks=t.breaks.filter(e=>e.startTime>r),await this.saveUserData(t)}}catch(e){throw console.error("Failed to add break session:",e),new Error("Failed to add break session")}}static async updateBreakSession(e,t){try{const a=await this.getUserData();if(a){const r=a.breaks.findIndex(t=>t.id===e);-1!==r&&(a.breaks[r]={...a.breaks[r],...t},await this.saveUserData(a))}}catch(e){throw console.error("Failed to update break session:",e),new Error("Failed to update break session")}}static async getBreakSessions(e,t){try{const a=await this.getUserData();if(!a)return[];let r=a.breaks;return e&&(r=r.filter(t=>t.startTime>=e.getTime())),t&&(r=r.filter(e=>e.startTime<=t.getTime())),r.sort((e,t)=>e.startTime-t.startTime)}catch(e){return console.error("Failed to get break sessions:",e),[]}}static async addEvent(e){try{const t=await this.getUserData();if(t){t.events.push(e);const a=t.settings.dataRetention,r=Date.now()-24*a*60*60*1e3;t.events=t.events.filter(e=>e.timestamp>r),await this.saveUserData(t)}}catch(e){throw console.error("Failed to add event:",e),new Error("Failed to add event")}}static async getStorageInfo(){try{return{used:await chrome.storage.local.getBytesInUse(),quota:chrome.storage.local.QUOTA_BYTES}}catch(e){return console.error("Failed to get storage info:",e),{used:0,quota:0}}}static async clearAllData(){try{await chrome.storage.local.clear(),await this.initialize()}catch(e){throw console.error("Failed to clear data:",e),new Error("Failed to clear data")}}static async exportData(){try{const e=await this.getUserData();if(!e)throw new Error("No data to export");return JSON.stringify(e,null,2)}catch(e){throw console.error("Failed to export data:",e),new Error("Failed to export data")}}static async importData(e){try{const t=JSON.parse(e);if(!t.settings||!t.metrics||!t.breaks)throw new Error("Invalid data format");await this.saveUserData(t)}catch(e){throw console.error("Failed to import data:",e),new Error("Failed to import data")}}}i.STORAGE_KEYS={USER_DATA:"eyezen_user_data",SETTINGS:"eyezen_settings",METRICS:"eyezen_metrics",BREAKS:"eyezen_breaks",EVENTS:"eyezen_events",LAST_SYNC:"eyezen_last_sync"};class n{static async initialize(){return new Promise((e,t)=>{const a=indexedDB.open(this.DB_NAME,this.DB_VERSION);a.onerror=()=>{t(new Error("Failed to open IndexedDB"))},a.onsuccess=()=>{this.db=a.result,e()},a.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.STORES.METRICS)){const e=t.createObjectStore(this.STORES.METRICS,{keyPath:"timestamp"});e.createIndex("date","date",{unique:!1}),e.createIndex("fatigueIndex","fatigueIndex",{unique:!1})}if(!t.objectStoreNames.contains(this.STORES.BREAKS)){const e=t.createObjectStore(this.STORES.BREAKS,{keyPath:"id"});e.createIndex("startTime","startTime",{unique:!1}),e.createIndex("type","type",{unique:!1})}if(!t.objectStoreNames.contains(this.STORES.EVENTS)){const e=t.createObjectStore(this.STORES.EVENTS,{keyPath:"id"});e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("type","type",{unique:!1})}t.objectStoreNames.contains(this.STORES.CACHE)||t.createObjectStore(this.STORES.CACHE,{keyPath:"key"})}})}static async storeMetrics(e){return this.db||await this.initialize(),new Promise((t,a)=>{const r=this.db.transaction([this.STORES.METRICS],"readwrite"),i=r.objectStore(this.STORES.METRICS);e.forEach(e=>{const t={...e,date:new Date(e.timestamp).toISOString().split("T")[0]};i.put(t)}),r.oncomplete=()=>t(),r.onerror=()=>a(new Error("Failed to store metrics"))})}static async queryMetrics(e){return this.db||await this.initialize(),new Promise((t,a)=>{const r=this.db.transaction([this.STORES.METRICS],"readonly"),i=r.objectStore(this.STORES.METRICS),n=[];let s;if(e.startDate||e.endDate){const t=i.index("timestamp"),a=IDBKeyRange.bound(e.startDate?.getTime()||0,e.endDate?.getTime()||Date.now());s=t.openCursor(a)}else s=i.openCursor();s.onsuccess=t=>{const a=t.target.result;if(a){const t=a.value;(!e.fatigueThreshold||t.fatigueIndex>=e.fatigueThreshold)&&n.push(t),(!e.limit||n.length<e.limit)&&a.continue()}},r.oncomplete=()=>t(n),r.onerror=()=>a(new Error("Failed to query metrics"))})}static async getDailyAggregates(e){const t=new Date(e);t.setHours(0,0,0,0);const a=new Date(e);a.setHours(23,59,59,999);const r=await this.queryMetrics({startDate:t,endDate:a});if(0===r.length)return{avgFatigue:0,avgBlinkRate:0,totalReadings:0,peakFatigue:0};const i=r.reduce((e,t)=>e+t.fatigueIndex,0),n=r.reduce((e,t)=>e+t.blinkRate,0),s=Math.max(...r.map(e=>e.fatigueIndex));return{avgFatigue:i/r.length,avgBlinkRate:n/r.length,totalReadings:r.length,peakFatigue:s}}static async setCache(e,t,a=36e5){return this.db||await this.initialize(),new Promise((r,i)=>{const n=this.db.transaction([this.STORES.CACHE],"readwrite").objectStore(this.STORES.CACHE),s={key:e,data:t,expires:Date.now()+a},o=n.put(s);o.onsuccess=()=>r(),o.onerror=()=>i(new Error("Failed to set cache"))})}static async getCache(e){return this.db||await this.initialize(),new Promise((t,a)=>{const r=this.db.transaction([this.STORES.CACHE],"readonly").objectStore(this.STORES.CACHE).get(e);r.onsuccess=()=>{const e=r.result;e&&e.expires>Date.now()?t(e.data):t(null)},r.onerror=()=>a(new Error("Failed to get cache"))})}static async clearExpiredCache(){return this.db||await this.initialize(),new Promise((e,t)=>{const a=this.db.transaction([this.STORES.CACHE],"readwrite");a.objectStore(this.STORES.CACHE).openCursor().onsuccess=e=>{const t=e.target.result;t&&(t.value.expires<=Date.now()&&t.delete(),t.continue())},a.oncomplete=()=>e(),a.onerror=()=>t(new Error("Failed to clear expired cache"))})}static async getDatabaseSize(){return this.db||await this.initialize(),new Promise(e=>{let t=0;const a=Array.from(this.db.objectStoreNames);let r=0;a.forEach(i=>{const n=this.db.transaction([i],"readonly").objectStore(i).count();n.onsuccess=()=>{t+=n.result,r++,r===a.length&&e(t)}})})}static async clearDatabase(){return this.db||await this.initialize(),new Promise((e,t)=>{const a=Array.from(this.db.objectStoreNames),r=this.db.transaction(a,"readwrite");a.forEach(e=>{r.objectStore(e).clear()}),r.oncomplete=()=>e(),r.onerror=()=>t(new Error("Failed to clear database"))})}}n.DB_NAME="EyeZenDB",n.DB_VERSION=1,n.STORES={METRICS:"metrics",BREAKS:"breaks",EVENTS:"events",CACHE:"cache"},n.db=null;class s{static async runMigrations(){try{const e=await this.getCurrentMigrationVersion();e<this.CURRENT_VERSION&&(await this.migrate(e,this.CURRENT_VERSION),await this.setMigrationVersion(this.CURRENT_VERSION))}catch(e){throw console.error("Migration failed:",e),new Error("Data migration failed")}}static async getCurrentMigrationVersion(){try{return(await chrome.storage.local.get([this.MIGRATION_KEY]))[this.MIGRATION_KEY]||0}catch(e){return 0}}static async setMigrationVersion(e){await chrome.storage.local.set({[this.MIGRATION_KEY]:e})}static async migrate(e,t){console.log(`Migrating data from version ${e} to ${t}`),await i.initialize(),await n.initialize()}}s.MIGRATION_KEY="eyezen_migration_version",s.CURRENT_VERSION=1},235:(e,t,a)=>{var r,i,n,s;a.r(t),a.d(t,{BreakType:()=>n,DEFAULT_SETTINGS:()=>c,EyeZenError:()=>o,MASSAGE_POINTS:()=>l,MassagePointType:()=>s,PostureStatus:()=>r,UserStatus:()=>i}),function(e){e.GOOD="good",e.FORWARD="forward",e.TILTED="tilted",e.TOO_CLOSE="too_close",e.TOO_FAR="too_far"}(r||(r={})),function(e){e.GOOD="good",e.TIRED="tired",e.CRITICAL="critical"}(i||(i={})),function(e){e.MICRO="micro",e.SHORT="short",e.LONG="long"}(n||(n={})),function(e){e.ZAN_ZHU="zan_zhu",e.SI_BAI="si_bai",e.JING_MING="jing_ming"}(s||(s={}));class o extends Error{constructor(e,t,a="medium"){super(e),this.code=t,this.severity=a,this.name="EyeZenError"}}const c={cameraEnabled:!1,detectionSensitivity:"medium",fatigueThreshold:70,reminderEnabled:!0,reminderInterval:20,breakDuration:20,dataRetention:30,metricsOnly:!1,language:"en",theme:"auto",notifications:!0,sounds:!0,dailyBreakGoal:8,eyeScoreGoal:80},l={[s.ZAN_ZHU]:{name:"Zan Zhu",chineseName:"攒竹",position:{x:.3,y:.25},description:"Inner end of eyebrow",benefits:["Relieves eye strain","Reduces headaches","Improves focus"],duration:30},[s.SI_BAI]:{name:"Si Bai",chineseName:"四白",position:{x:.35,y:.45},description:"Below the center of the eye",benefits:["Brightens eyes","Reduces dark circles","Improves circulation"],duration:30},[s.JING_MING]:{name:"Jing Ming",chineseName:"睛明",position:{x:.25,y:.35},description:"Inner corner of the eye",benefits:["Clears vision","Reduces eye fatigue","Calms the mind"],duration:30}}},463:(e,t)=>{function a(e,t){var a=e.length;e.push(t);e:for(;0<a;){var r=a-1>>>1,i=e[r];if(!(0<n(i,t)))break e;e[r]=t,e[a]=i,a=r}}function r(e){return 0===e.length?null:e[0]}function i(e){if(0===e.length)return null;var t=e[0],a=e.pop();if(a!==t){e[0]=a;e:for(var r=0,i=e.length,s=i>>>1;r<s;){var o=2*(r+1)-1,c=e[o],l=o+1,u=e[l];if(0>n(c,a))l<i&&0>n(u,c)?(e[r]=u,e[l]=a,r=l):(e[r]=c,e[o]=a,r=o);else{if(!(l<i&&0>n(u,a)))break e;e[r]=u,e[l]=a,r=l}}}return t}function n(e,t){var a=e.sortIndex-t.sortIndex;return 0!==a?a:e.id-t.id}if("object"==typeof performance&&"function"==typeof performance.now){var s=performance;t.unstable_now=function(){return s.now()}}else{var o=Date,c=o.now();t.unstable_now=function(){return o.now()-c}}var l=[],u=[],d=1,h=null,f=3,g=!1,m=!1,y=!1,S="function"==typeof setTimeout?setTimeout:null,E="function"==typeof clearTimeout?clearTimeout:null,b="undefined"!=typeof setImmediate?setImmediate:null;function w(e){for(var t=r(u);null!==t;){if(null===t.callback)i(u);else{if(!(t.startTime<=e))break;i(u),t.sortIndex=t.expirationTime,a(l,t)}t=r(u)}}function p(e){if(y=!1,w(e),!m)if(null!==r(l))m=!0,x(T);else{var t=r(u);null!==t&&F(p,t.startTime-e)}}function T(e,a){m=!1,y&&(y=!1,E(_),_=-1),g=!0;var n=f;try{for(w(a),h=r(l);null!==h&&(!(h.expirationTime>a)||e&&!C());){var s=h.callback;if("function"==typeof s){h.callback=null,f=h.priorityLevel;var o=s(h.expirationTime<=a);a=t.unstable_now(),"function"==typeof o?h.callback=o:h===r(l)&&i(l),w(a)}else i(l);h=r(l)}if(null!==h)var c=!0;else{var d=r(u);null!==d&&F(p,d.startTime-a),c=!1}return c}finally{h=null,f=n,g=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var v,I=!1,R=null,_=-1,D=5,k=-1;function C(){return!(t.unstable_now()-k<D)}function A(){if(null!==R){var e=t.unstable_now();k=e;var a=!0;try{a=R(!0,e)}finally{a?v():(I=!1,R=null)}}else I=!1}if("function"==typeof b)v=function(){b(A)};else if("undefined"!=typeof MessageChannel){var O=new MessageChannel,N=O.port2;O.port1.onmessage=A,v=function(){N.postMessage(null)}}else v=function(){S(A,0)};function x(e){R=e,I||(I=!0,v())}function F(e,a){_=S(function(){e(t.unstable_now())},a)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(e){e.callback=null},t.unstable_continueExecution=function(){m||g||(m=!0,x(T))},t.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):D=0<e?Math.floor(1e3/e):5},t.unstable_getCurrentPriorityLevel=function(){return f},t.unstable_getFirstCallbackNode=function(){return r(l)},t.unstable_next=function(e){switch(f){case 1:case 2:case 3:var t=3;break;default:t=f}var a=f;f=t;try{return e()}finally{f=a}},t.unstable_pauseExecution=function(){},t.unstable_requestPaint=function(){},t.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var a=f;f=e;try{return t()}finally{f=a}},t.unstable_scheduleCallback=function(e,i,n){var s=t.unstable_now();switch(n="object"==typeof n&&null!==n&&"number"==typeof(n=n.delay)&&0<n?s+n:s,e){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return e={id:d++,callback:i,priorityLevel:e,startTime:n,expirationTime:o=n+o,sortIndex:-1},n>s?(e.sortIndex=n,a(u,e),null===r(l)&&e===r(u)&&(y?(E(_),_=-1):y=!0,F(p,n-s))):(e.sortIndex=o,a(l,e),m||g||(m=!0,x(T))),e},t.unstable_shouldYield=C,t.unstable_wrapCallback=function(e){var t=f;return function(){var a=f;f=t;try{return e.apply(this,arguments)}finally{f=a}}}},982:(e,t,a)=>{e.exports=a(463)}}]);