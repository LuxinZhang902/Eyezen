<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Alarm System - EyeZen</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.danger {
            background: #f44336;
        }
        .button.danger:hover {
            background: #da190b;
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß EyeZen Alarm System Debug</h1>
        
        <div class="section">
            <h2>üìä Current Status</h2>
            <div id="status">Loading...</div>
            <button class="button" onclick="checkStatus()">Refresh Status</button>
        </div>
        
        <div class="section">
            <h2>‚è∞ Alarm Management</h2>
            <button class="button" onclick="listAlarms()">List All Alarms</button>
            <button class="button" onclick="setupAlarms()">Setup Test Alarms</button>
            <button class="button danger" onclick="clearAllAlarms()">Clear All Alarms</button>
            <button class="button" onclick="triggerTestNotification()">Test Notification</button>
        </div>
        
        <div class="section">
            <h2>üíæ Storage Debug</h2>
            <button class="button" onclick="checkUserData()">Check User Data</button>
            <button class="button" onclick="initializeUserData()">Initialize User Data</button>
            <button class="button" onclick="enableReminders()">Enable Reminders</button>
        </div>
        
        <div class="section">
            <h2>üìù Debug Log</h2>
            <div id="log" class="log">Debug log will appear here...</div>
            <button class="button" onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            
            logElement.textContent += logMessage + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.textContent = '';
        }
        
        function updateStatus(message, type = 'info') {
            statusElement.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        async function checkStatus() {
            try {
                log('üîç Checking extension status...');
                
                // Check if extension APIs are available
                if (!chrome || !chrome.runtime) {
                    updateStatus('‚ùå Chrome extension APIs not available', 'error');
                    return;
                }
                
                // Send message to background script
                const response = await chrome.runtime.sendMessage({ action: 'GET_STATUS' });
                log(`üìä Status response: ${JSON.stringify(response, null, 2)}`);
                updateStatus('‚úÖ Extension is running', 'success');
                
            } catch (error) {
                log(`‚ùå Error checking status: ${error.message}`);
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function listAlarms() {
            try {
                log('üìã Listing all alarms...');
                const alarms = await chrome.alarms.getAll();
                
                if (alarms.length === 0) {
                    log('‚ùå No alarms found!');
                    updateStatus('‚ùå No alarms are currently set', 'error');
                } else {
                    log(`‚úÖ Found ${alarms.length} alarms:`);
                    alarms.forEach(alarm => {
                        const scheduledTime = new Date(alarm.scheduledTime).toLocaleString();
                        log(`  - ${alarm.name}: scheduled for ${scheduledTime}`);
                    });
                    updateStatus(`‚úÖ Found ${alarms.length} active alarms`, 'success');
                }
            } catch (error) {
                log(`‚ùå Error listing alarms: ${error.message}`);
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function setupAlarms() {
            try {
                log('üîß Setting up test alarms...');
                await chrome.runtime.sendMessage({ action: 'SETUP_ALARMS' });
                log('‚úÖ Alarms setup completed');
                updateStatus('‚úÖ Test alarms have been set up', 'success');
                
                // List alarms after setup
                setTimeout(listAlarms, 1000);
            } catch (error) {
                log(`‚ùå Error setting up alarms: ${error.message}`);
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function clearAllAlarms() {
            try {
                log('üßπ Clearing all alarms...');
                await chrome.alarms.clearAll();
                log('‚úÖ All alarms cleared');
                updateStatus('‚úÖ All alarms have been cleared', 'success');
            } catch (error) {
                log(`‚ùå Error clearing alarms: ${error.message}`);
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function triggerTestNotification() {
            try {
                log('üîî Triggering test notification...');
                await chrome.runtime.sendMessage({ action: 'TEST_NOTIFICATION' });
                log('‚úÖ Test notification sent');
                updateStatus('‚úÖ Test notification has been sent', 'success');
            } catch (error) {
                log(`‚ùå Error sending test notification: ${error.message}`);
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function checkUserData() {
            try {
                log('üíæ Checking user data...');
                const response = await chrome.runtime.sendMessage({ action: 'GET_USER_DATA' });
                log(`üìä User data: ${JSON.stringify(response, null, 2)}`);
                
                if (response && response.settings) {
                    const enabled = response.settings.reminderEnabled;
                    const interval = response.settings.reminderInterval;
                    updateStatus(`‚úÖ Reminders: ${enabled ? 'Enabled' : 'Disabled'}, Interval: ${interval} min`, 'success');
                } else {
                    updateStatus('‚ùå No user data found', 'error');
                }
            } catch (error) {
                log(`‚ùå Error checking user data: ${error.message}`);
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function initializeUserData() {
            try {
                log('üîß Initializing user data...');
                await chrome.runtime.sendMessage({ action: 'INITIALIZE_USER_DATA' });
                log('‚úÖ User data initialized');
                updateStatus('‚úÖ User data has been initialized', 'success');
            } catch (error) {
                log(`‚ùå Error initializing user data: ${error.message}`);
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        async function enableReminders() {
            try {
                log('‚úÖ Enabling reminders with 1-minute interval...');
                await chrome.runtime.sendMessage({ 
                    action: 'UPDATE_SETTINGS', 
                    settings: { 
                        reminderEnabled: true, 
                        reminderInterval: 1 
                    } 
                });
                log('‚úÖ Reminders enabled');
                updateStatus('‚úÖ Reminders enabled with 1-minute interval', 'success');
                
                // Setup alarms after enabling
                setTimeout(setupAlarms, 1000);
            } catch (error) {
                log(`‚ùå Error enabling reminders: ${error.message}`);
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Debug page loaded');
            checkStatus();
        });
        
        // Listen for alarm events
        if (chrome && chrome.alarms) {
            chrome.alarms.onAlarm.addListener((alarm) => {
                log(`üö® Alarm triggered: ${alarm.name} at ${new Date(alarm.scheduledTime).toLocaleString()}`);
            });
        }
    </script>
</body>
</html>