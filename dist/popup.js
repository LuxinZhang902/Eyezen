/*! For license information please see popup.js.LICENSE.txt */
(()=>{"use strict";var e,r,t,n={455:(e,r,t)=>{var n=t(848),a=t(338),o=t(540),s=t(235),i=t(123);class l{constructor(){this.session=null,this.isInitialized=!1}async initialize(){if(!("LanguageModel"in window))throw console.warn("Chrome AI Prompt API not available"),new Error('Chrome AI is not available. Please ensure you are using Chrome 127+ with the following flags enabled:\n\n1. chrome://flags/#optimization-guide-on-device-model → "Enabled BypassPerfRequirement"\n2. chrome://flags/#prompt-api-for-gemini-nano → "Enabled"\n\nThen restart Chrome completely.');const e=await window.LanguageModel.availability();if(console.log("Chrome AI model availability:",e),"no"===e)throw console.warn("Chrome AI model not available on this device"),new Error("Chrome AI is not available on this device. This may be due to:\n\n• Hardware requirements not met (need 22GB+ free space, 4GB+ VRAM)\n• Operating system not supported (requires macOS 13+ or Windows 10+)\n• Chrome flags not properly enabled\n\nPlease check the requirements and try again.");if("after-download"===e)console.log("Chrome AI model needs to be downloaded. Starting download..."),this.session=await window.languageModel.create({topK:3,temperature:.3,monitor(e){e.addEventListener("downloadprogress",e=>{const r=Math.round(100*e.loaded);console.log(`Chrome AI model download progress: ${r}%`)})}});else{if("available"!==e)throw console.warn("Unknown Chrome AI availability status:",e),new Error(`Chrome AI availability status is unknown: ${e}`);this.session=await window.LanguageModel.create({topK:3,temperature:.3})}this.isInitialized=!0,console.log("Chrome AI service initialized successfully")}async generateHealthSuggestion(e,r,t){this.isInitialized||await this.initialize();try{const n=this.buildHealthPrompt(e,r,t);console.log("Sending prompt to Chrome AI:",n);const a=await this.session.prompt(n);return console.log("Chrome AI response:",a),this.parseAIResponse(a,e,r,t)}catch(e){console.error("Chrome AI suggestion generation failed:",e);const r=e instanceof Error?e.message:"Unknown error occurred";throw new Error(`Chrome AI failed to generate suggestion: ${r}`)}}buildHealthPrompt(e,r,t){return`As an eye health expert, provide a brief personalized tip (max 40 words) based on these metrics:\n\nEye Health Score: ${e}/100\nFatigue Level: ${r}/100\nBlink Rate: ${t.blinkRate} blinks/min (normal: 15-20)\nEye Strain Index: ${(100*t.fatigueIndex).toFixed(1)}%\nPosture Status: ${t.posture}\n\nProvide a unique suggestion that is NOT a break activity. Focus on:\n- Environment adjustments (lighting, screen distance, humidity)\n- Workspace ergonomics (monitor height, chair position)\n- Daily habits (hydration, nutrition, sleep)\n- Posture improvements\n\nProvide:\n1. One specific actionable tip\n2. Urgency level (low/medium/high)\n3. Category (environment/posture/habits/nutrition/workspace)\n\nFormat: "[Tip] | [Urgency] | [Category]"`}parseAIResponse(e,r,t,n){try{const r=e.split("|").map(e=>e.trim());if(r.length>=3){const e=r[0];return{message:e,severity:this.normalizeSeverity(r[1]),category:this.normalizeCategory(r[2]),confidence:.85}}}catch(e){console.warn("Failed to parse AI response:",e)}return{message:e.substring(0,100),severity:this.determineSeverity(r,t),category:this.determineCategory(t,n),confidence:.7}}normalizeSeverity(e){const r=e.toLowerCase();return r.includes("high")||r.includes("urgent")||r.includes("critical")?"high":r.includes("medium")||r.includes("moderate")?"medium":"low"}normalizeCategory(e){const r=e.toLowerCase();return r.includes("environment")||r.includes("lighting")||r.includes("humidity")?"environment":r.includes("posture")||r.includes("position")?"posture":r.includes("habits")||r.includes("sleep")||r.includes("routine")?"habits":r.includes("nutrition")||r.includes("hydration")||r.includes("food")?"nutrition":r.includes("workspace")||r.includes("ergonomic")||r.includes("monitor")?"workspace":"environment"}determineSeverity(e,r){return r>70||e<30?"high":r>40||e<60?"medium":"low"}determineCategory(e,r){return r.posture===s.PostureStatus.FORWARD||r.posture===s.PostureStatus.TILTED?"posture":e>60?"habits":r.blinkRate<10?"environment":r.fatigueIndex>.5?"workspace":"environment"}getFallbackSuggestion(e,r,t){const n=this.determineSeverity(e,r),a=this.determineCategory(r,t);return{message:{environment:"Adjust your screen brightness to match room lighting and increase humidity.",posture:"Position your monitor 20-26 inches away and top of screen at eye level.",habits:"Stay hydrated with 8 glasses of water daily and get 7-8 hours of sleep.",nutrition:"Include omega-3 rich foods and leafy greens in your diet for eye health.",workspace:"Use proper lighting behind your screen and consider blue light filters."}[a],severity:n,category:a,confidence:.6}}async destroy(){if(this.session){try{await this.session.destroy()}catch(e){console.warn("Error destroying Chrome AI session:",e)}this.session=null}this.isInitialized=!1}}new l;const c=(0,o.lazy)(()=>t.e(57).then(t.bind(t,57))),d=(0,o.lazy)(()=>t.e(277).then(t.bind(t,277))),m=(0,o.lazy)(()=>t.e(410).then(t.bind(t,410))),u=(0,o.lazy)(()=>t.e(826).then(t.bind(t,826))),h=new l,g=()=>t.e(911).then(t.bind(t,911)).then(e=>e.EyeHealthScorer),p=({onStartBreak:e,onOpenSettings:r})=>{const t=(0,o.useRef)(0),[a,l]=(0,o.useState)({status:s.UserStatus.GOOD,eyeScore:{current:50,daily:50,weekly:50,trend:"stable"},realtimeScore:-1,isLoading:!0,cameraEnabled:!1,lastBreakTime:null,streakDays:0,showCameraPermissionPopup:!1,isFeatureRestricted:!1,aiRecommendation:"Analyzing your eye health patterns...",aiCategory:"environment",aiLoading:!0,showLoginModal:!1,isLoggedIn:!1,userEmail:"",isModalOpen:!1,selectedBreakType:null,showReminderModal:!1,reminderInterval:30,isReminderActive:!1});(0,o.useEffect)(()=>{console.log("🔥 POPUP: useEffect triggered, calling loadUserData"),f(),p();const e=setInterval(()=>{a.cameraEnabled&&f()},3e4),r=setInterval(k,5e3),t=setInterval(()=>{a.cameraEnabled&&C()},1e4),n=(e,r,t)=>{console.log("🔥 POPUP: Message received:",e.type,e),"EYE_METRICS"===e.type&&(console.log("🔥 POPUP: EYE_METRICS message received, calling handleEyeMetrics"),y(e.data))};if("undefined"!=typeof chrome&&chrome.runtime){chrome.runtime.onMessage.addListener(n),setTimeout(()=>{console.log("🧪 POPUP: Sending test message to service worker"),chrome.runtime.sendMessage({type:"POPUP_TEST",data:"Hello from popup"},e=>{chrome.runtime.lastError?console.log("🧪 POPUP: Test message failed (service worker may not be ready):",chrome.runtime.lastError.message):console.log("🧪 POPUP: Test message response:",e)})},1e3);const e=setInterval(async()=>{try{const e=await chrome.storage.local.get(["latest_eye_metrics"]);if(e.latest_eye_metrics){const{data:r,timestamp:t}=e.latest_eye_metrics;Date.now()-t<5e3&&(console.log("🔄 POPUP: Processing eye metrics from storage fallback:",r),y(r),await chrome.storage.local.remove(["latest_eye_metrics"]))}}catch(e){console.log("🔄 POPUP: Error polling storage for metrics:",e)}},1e3);window.storagePollingInterval=e}const o=(e,r)=>{"local"===r&&e.eyezen_login_state&&(console.log("Popup: Login state changed in storage:",e.eyezen_login_state),p())};return"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.addListener(o),()=>{clearInterval(e),clearInterval(r),clearInterval(t),window.storagePollingInterval&&clearInterval(window.storagePollingInterval),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage.removeListener(n),"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.removeListener(o)}},[]);const p=async()=>{try{if("undefined"!=typeof chrome&&chrome.storage){const e=(await chrome.storage.local.get(["eyezen_login_state"])).eyezen_login_state;e&&e.isLoggedIn&&l(r=>({...r,isLoggedIn:!0,userEmail:e.userEmail}))}}catch(e){console.error("Failed to load login state:",e)}},f=async()=>{console.log("🔥 POPUP: loadUserData function called");try{let e=await i.ChromeStorageService.getUserData();if(e||(await i.ChromeStorageService.initialize(),e=await i.ChromeStorageService.getUserData()),e){const r=e.metrics.slice(-10);console.log("🔍 POPUP: Recent metrics for health score calculation:",r.length,r);const t=(await g()).calculateScore(r);console.log("🔍 POPUP: Calculated health score:",t);const n=w(t.overall,r),a=b(e.breaks),o=e.breaks.filter(e=>e.completed).sort((e,r)=>r.endTime-e.endTime)[0],s=r.reduce((e,r)=>e+(r.fatigueIndex||0),0)/r.length;let i="environment",c="Analyzing your eye health patterns...";s>.7?(i="workspace",c="Consider optimizing your workspace setup for better eye health."):s>.4&&(i="posture",c="Focus on maintaining proper posture and screen distance.");const d=r[r.length-1],m=d?Math.round(Math.max(0,Math.min(100,100-100*d.fatigueIndex))):-1;window.eyeZenCameraStream=null,console.log("🔍 POPUP: Setting eyeScore.current to:",t.overall),l(r=>({...r,status:n,eyeScore:{current:t.overall,daily:t.overall,weekly:t.overall,trend:t.trend},realtimeScore:m,isLoading:!1,cameraEnabled:e.settings.cameraEnabled,lastBreakTime:o?.endTime||null,streakDays:a,showCameraPermissionPopup:!1,isFeatureRestricted:e.settings.metricsOnly,aiRecommendation:c,aiCategory:i,aiLoading:!1,showLoginModal:!1}))}}catch(e){console.error("🔥 POPUP: Failed to load user data:",e),console.error("🔥 POPUP: Error stack:",e instanceof Error?e.stack:"No stack trace"),l(e=>({...e,isLoading:!1}))}},y=async e=>{try{const r=(new Date).toISOString();console.log(`🔥 [${r}] POPUP: handleEyeMetrics called with:`,e),Date.now()-t.current>1e4&&(console.log("👤 Face detected! Received eye metrics:",e),console.log("📊 Real-time fatigue index:",e.fatigueIndex,"Blink rate:",e.blinkRate),t.current=Date.now());const n={timestamp:Date.now(),blinkRate:e.blinkRate||0,fatigueIndex:e.fatigueIndex||0,posture:e.posture||"unknown",earValue:e.earLeft||e.earRight||0,perclosValue:e.perclos||0};await i.ChromeStorageService.addMetrics(n);const a=[n],o=(await g()).calculateScore(a),s=o.overall,c=Math.max(0,Math.min(100,100-100*e.fatigueIndex)),d=w(s,[e]);console.log(`🔥 [${r}] POPUP: Score calculation:`),console.log(`  - fatigueIndex: ${e.fatigueIndex}`),console.log(`  - Eye Health Score: ${s}`),console.log(`  - realtimeFatigueScore: ${c}`),console.log("  - Health Score Details:",o),console.log(`  - rounded Eye Health score: ${Math.round(s)}`),l(e=>({...e,status:d,eyeScore:{...e.eyeScore,current:Math.round(s)},realtimeScore:Math.round(c)})),console.log(`🔥 [${r}] POPUP: Updated realtimeScore:`,Math.round(c))}catch(e){console.error("Error handling eye metrics:",e)}},w=(e,r)=>e>=80?s.UserStatus.GOOD:e>=60?s.UserStatus.TIRED:s.UserStatus.CRITICAL,b=e=>{const r=new Date;let t=0;for(let n=0;n<30;n++){const a=new Date(r);a.setDate(a.getDate()-n),a.setHours(0,0,0,0);const o=new Date(a);if(o.setHours(23,59,59,999),!(e.filter(e=>{const r=new Date(e.startTime);return r>=a&&r<=o&&e.completed}).length>=3)){if(0===n)break;break}t++}return t},v=e=>e>=80?"text-green-600":e>=60?"text-yellow-600":"text-red-600",x=e=>{l(r=>({...r,selectedBreakType:e,isModalOpen:!0}))},k=async()=>{try{const e=await navigator.permissions.query({name:"camera"}),r=window.eyeZenCameraStream;"denied"===e.state&&r&&(console.log("Camera permission revoked, updating extension state"),window.eyeZenCameraStream=null,await i.ChromeStorageService.updateSettings({cameraEnabled:!1}),l(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,realtimeScore:0})),chrome.runtime.sendMessage({type:"STOP_CAMERA"},e=>{chrome.runtime.lastError?console.error("❌ Error stopping camera due to permission revocation:",chrome.runtime.lastError.message):e?.success&&console.log("Camera stopped due to permission revocation")}))}catch(e){console.log("Could not check camera permission status:",e)}},C=async()=>{try{if(!a.cameraEnabled)return;chrome.runtime.sendMessage({type:"GET_CAMERA_STATE"},e=>{if(chrome.runtime.lastError)a.cameraEnabled&&console.error("❌ Error validating camera state:",chrome.runtime.lastError.message);else if(e&&void 0!==e.isActive){const r=e.isActive;a.cameraEnabled!==r&&(window.eyeZenCameraStream=!!r||null,l(e=>({...e,cameraEnabled:r})),i.ChromeStorageService.updateSettings({cameraEnabled:r}))}})}catch(e){a.cameraEnabled&&console.log("Could not validate camera state:",e)}};return(0,o.useEffect)(()=>{(async()=>{try{const e=await chrome.storage.local.get(["eyezen_reminder"]);e.eyezen_reminder&&e.eyezen_reminder.isActive&&l(r=>({...r,isReminderActive:!0,reminderInterval:e.eyezen_reminder.interval}))}catch(e){console.error("Failed to load reminder state:",e)}})()},[]),a.isLoading?(0,n.jsx)("div",{className:"w-[380px] h-[550px] bg-white flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),(0,n.jsx)("p",{className:"text-gray-600",children:"Loading EyeZen..."})]})}):(0,n.jsxs)(n.Fragment,{children:[a.showCameraPermissionPopup&&(0,n.jsx)(o.Suspense,{fallback:(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,n.jsx)(c,{isVisible:a.showCameraPermissionPopup,onApprove:async()=>{try{await i.ChromeStorageService.updateSettings({cameraEnabled:!0,metricsOnly:!1}),window.eyeZenCameraStream=!0,l(e=>({...e,cameraEnabled:!0,showCameraPermissionPopup:!1,isFeatureRestricted:!1}))}catch(e){console.error("Failed to approve camera access:",e)}},onReject:async()=>{try{await i.ChromeStorageService.updateSettings({cameraEnabled:!1,metricsOnly:!0}),window.eyeZenCameraStream=null,l(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,isFeatureRestricted:!0}))}catch(e){console.error("Failed to reject camera access:",e)}},onClose:()=>l(e=>({...e,showCameraPermissionPopup:!1}))})}),(0,n.jsx)(o.Suspense,{fallback:(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,n.jsx)(d,{isVisible:a.showLoginModal,onClose:()=>l(e=>({...e,showLoginModal:!1})),onLogin:async(e,r)=>{console.log("Login attempt:",{email:e});try{await new Promise(e=>setTimeout(e,1e3));const t=(await chrome.storage.local.get(["eyezen_users"])).eyezen_users||{};if(!t[e])throw new Error("No account found with this email address. Please sign up first.");if(t[e].password!==r)throw new Error("Incorrect password. Please try again.");l(r=>({...r,isLoggedIn:!0,userEmail:e,showLoginModal:!1})),await chrome.storage.local.set({eyezen_login_state:{isLoggedIn:!0,userEmail:e,loginTime:Date.now()}})}catch(e){throw e}},onSignup:async(e,r,t)=>{console.log("Signup attempt:",{email:e,name:t});try{await new Promise(e=>setTimeout(e,1e3));const n=(await chrome.storage.local.get(["eyezen_users"])).eyezen_users||{};if(n[e])throw new Error("An account with this email already exists. Please login instead.");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))throw new Error("Please enter a valid email address.");if(r.length<6)throw new Error("Password must be at least 6 characters long.");const a={email:e,password:r,name:t,createdAt:Date.now(),verified:!0};n[e]=a,await chrome.storage.local.set({eyezen_users:n}),l(r=>({...r,isLoggedIn:!0,userEmail:e,showLoginModal:!1})),await chrome.storage.local.set({eyezen_login_state:{isLoggedIn:!0,userEmail:e,loginTime:Date.now()}}),console.log("Signup successful")}catch(e){throw console.error("Signup failed:",e),e}}})}),(0,n.jsxs)("div",{className:"w-[380px] h-[650px] bg-white flex flex-col relative",children:[(0,n.jsxs)("div",{className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white p-4",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,n.jsx)("div",{className:"text-2xl",children:"👁️"}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-lg font-bold",children:"EyeZen"}),(0,n.jsx)("p",{className:"text-blue-100 text-xs opacity-90",children:"Eye Health Monitor"})]})]}),(0,n.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,n.jsxs)("button",{onClick:()=>l(e=>({...e,showReminderModal:!0})),className:"p-2 hover:bg-white/20 rounded-lg transition-colors "+(a.isReminderActive?"bg-yellow-500/30 text-yellow-200":""),title:a.isReminderActive?"Break reminder active":"Set break reminder",children:[(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),a.isReminderActive&&(0,n.jsx)("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-yellow-400 rounded-full"})]}),a.isLoggedIn?(0,n.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,n.jsx)("span",{className:"text-xs text-blue-100 opacity-90 truncate max-w-20",children:a.userEmail.split("@")[0]}),(0,n.jsx)("button",{onClick:async()=>{await chrome.storage.local.remove(["eyezen_login_state"]),l(e=>({...e,isLoggedIn:!1,userEmail:""}))},className:"p-1 hover:bg-white/20 rounded transition-colors",title:"Logout",children:(0,n.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})})})]}):(0,n.jsx)("button",{onClick:()=>l(e=>({...e,showLoginModal:!0})),className:"p-2 hover:bg-white/20 rounded-lg transition-colors",title:"Login",children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})})]})]}),(0,n.jsx)("div",{className:"bg-white/10 backdrop-blur-sm rounded-lg p-3 border border-white/20",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,n.jsx)("div",{className:"text-lg",children:"📹"}),(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsx)("div",{className:"font-semibold text-sm",children:"Camera Monitoring"}),(0,n.jsx)("div",{className:"text-xs text-blue-100 opacity-90",children:a.cameraEnabled?"Active - Tracking eye health":"Inactive - Click to enable"}),!a.cameraEnabled&&(0,n.jsx)("button",{onClick:()=>l(e=>({...e,showCameraPermissionPopup:!0})),className:"text-xs text-blue-200 hover:text-white underline mt-1 transition-colors",children:"Need help? View setup guide"}),a.cameraEnabled&&(0,n.jsxs)("button",{onClick:async()=>{try{if(!a.cameraEnabled)return void alert("Camera must be enabled to capture frames");const e=await new Promise((e,r)=>{chrome.runtime.sendMessage({type:"DOWNLOAD_FRAME"},t=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):t?e(t):r(new Error("No response received from offscreen document"))})});e.success?(console.log("📸 Frame downloaded successfully:",e.filename),alert(`Frame saved as: ${e.filename}`)):(console.error("❌ Failed to download frame:",e.error),alert(`Failed to download frame: ${e.error}`))}catch(e){console.error("Failed to download frame:",e),alert("Failed to download frame. Please try again.")}},className:"text-xs text-blue-200 hover:text-white underline mt-1 transition-colors flex items-center space-x-1",children:[(0,n.jsx)("span",{children:"📸"}),(0,n.jsx)("span",{children:"Download Current Frame"})]})]})]}),(0,n.jsx)("button",{onClick:async()=>{try{a.cameraEnabled?await(async()=>{try{chrome.runtime.sendMessage({type:"STOP_CAMERA"},e=>{chrome.runtime.lastError?console.error("❌ Error stopping camera:",chrome.runtime.lastError.message):e?.success&&console.log("Camera stopped successfully")}),window.eyeZenCameraStream=null,await i.ChromeStorageService.updateSettings({cameraEnabled:!1}),l(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,realtimeScore:0})),console.log("Camera deactivated")}catch(e){console.error("Failed to stop camera:",e)}})():await(async()=>{try{if(!confirm("📹 Camera Permission Setup\n\n🔒 Your privacy is protected - no video is recorded or transmitted, and images are only used for one-time analysis.\nContinue? (Cancel for timer-only mode)"))return await i.ChromeStorageService.updateSettings({cameraEnabled:!1,metricsOnly:!0}),void l(e=>({...e,cameraEnabled:!1,isFeatureRestricted:!0}));(await chrome.runtime.getContexts({})).find(e=>"OFFSCREEN_DOCUMENT"===e.contextType)||await chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Camera access for eye health monitoring"});const e=await new Promise((e,r)=>{chrome.runtime.sendMessage({type:"REQUEST_CAMERA"},t=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):t?e(t):r(new Error("No response received from offscreen document"))})});if(e.success)await i.ChromeStorageService.updateSettings({cameraEnabled:!0,metricsOnly:!1}),window.eyeZenCameraStream=!0,l(e=>({...e,cameraEnabled:!0,showCameraPermissionPopup:!1,isFeatureRestricted:!1})),console.log("Camera activated successfully"),alert(" Success! Camera is now active and AI eye health monitoring is running.");else{console.warn("Camera access denied:",e.error),await i.ChromeStorageService.updateSettings({cameraEnabled:!1,metricsOnly:!0}),window.eyeZenCameraStream=null,l(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,isFeatureRestricted:!0}));const r=`${e.error||"Camera access was denied."}\n\n🔧 **Why "Ask" doesn't work:**\nChrome extension popups close when permission dialogs appear, preventing you from clicking "Allow".\n\n**Solution - Set to "Always Allow":**\n\n**Method 1 - Chrome Address Bar:**\n1. Look for the camera icon (🎥) in Chrome's address bar\n2. Click it and select "Always allow"\n3. Refresh this extension\n\n**Method 2 - Chrome Settings:**\n1. Chrome Settings → Privacy and Security → Site Settings\n2. Click "Camera" → find this extension\n3. Change from "Ask" to "Allow"\n4. Refresh this extension\n\n✅ You can still use basic timer reminders without camera access.`;alert(r)}}catch(e){console.error("Failed to request camera access:",e),alert("Failed to request camera access. Please try again.")}})()}catch(e){console.error("Failed to toggle camera:",e)}},className:"relative inline-flex h-6 w-11 items-center rounded-full transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-white/50 "+(a.cameraEnabled?"bg-green-500 shadow-lg":"bg-white/30"),children:(0,n.jsx)("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 shadow-md "+(a.cameraEnabled?"translate-x-6":"translate-x-1")})})]})})]}),(0,n.jsx)("div",{className:"p-3 relative",children:(0,n.jsx)("div",{className:"text-center mb-3",children:(0,n.jsxs)("div",{className:"bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-3 mx-1 mb-2 border border-gray-100 shadow-sm",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-lg mr-2",children:a.eyeScore.current>=80?"😊":a.eyeScore.current>=60?"😐":a.eyeScore.current>=40?"😟":"😵"}),(0,n.jsx)("h2",{className:"text-sm font-semibold text-gray-800",children:"Eye Health Score"})]}),(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{className:`text-xl font-bold ${v(a.eyeScore.current)}`,children:a.eyeScore.current}),(0,n.jsx)("span",{className:"text-sm text-gray-500 ml-1",children:"/100"}),a.cameraEnabled&&50===a.eyeScore.current&&(0,n.jsxs)("span",{className:"ml-2 text-xs text-blue-600 font-medium flex items-center",children:[(0,n.jsx)("span",{className:"animate-spin mr-1",children:"🔄"}),"Analyzing..."]})]})]}),(0,n.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-1.5 mb-2",children:(0,n.jsx)("div",{className:"h-1.5 rounded-full transition-all duration-500 "+(v(a.eyeScore.current).includes("green")?"bg-green-500":v(a.eyeScore.current).includes("yellow")?"bg-yellow-500":"bg-red-500"),style:{width:`${a.eyeScore.current}%`}})}),(0,n.jsx)("div",{className:"text-xs text-gray-500 text-center mb-2",children:"Based on eye strain, posture, fatigue levels"}),(0,n.jsx)("div",{className:"mt-3",children:(0,n.jsx)("button",{onClick:async()=>{try{l(e=>({...e,aiLoading:!0}));const e=a.eyeScore.current||50,r=a.realtimeScore||50,t={blinkRate:15,fatigueIndex:r/100,posture:"good",earValue:.25,perclosValue:.2,timestamp:Date.now()},n=await h.generateHealthSuggestion(e,r,t);l(e=>({...e,aiRecommendation:n.message,aiCategory:n.category,aiLoading:!1})),alert(`AI Health Suggestion (${n.category}):\n\n${n.message}`)}catch(e){console.error("Failed to generate AI recommendation:",e),l(e=>({...e,aiLoading:!1}));const r=e instanceof Error?e.message:"Unknown error occurred";alert(`Chrome AI Error: ${r}`)}},disabled:a.aiLoading,className:"w-full px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-400 hover:to-emerald-400 transition-all duration-200 font-medium flex items-center justify-center space-x-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:a.aiLoading?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"}),(0,n.jsx)("span",{children:"Getting AI Suggestions..."})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{children:"🤖"}),(0,n.jsx)("span",{children:"Get AI Health Suggestions"})]})})})]})})}),(0,n.jsxs)("div",{className:"px-4 pb-4 flex-1 overflow-y-auto",children:[(0,n.jsxs)("div",{className:"mb-2",children:[(0,n.jsx)("h3",{className:"text-xs font-medium text-gray-600 mb-1",children:"Choose Your Break"}),(0,n.jsxs)("div",{className:"grid grid-cols-3 gap-1",children:[(0,n.jsxs)("button",{onClick:()=>x(s.BreakType.MICRO),className:"flex flex-col items-center p-2 bg-gradient-to-br from-yellow-300 to-orange-400 hover:from-yellow-400 hover:to-orange-500 rounded border border-orange-300 transition-all duration-200 hover:shadow-md text-white",children:[(0,n.jsx)("span",{className:"text-lg mb-1",children:"⚡"}),(0,n.jsx)("span",{className:"text-xs font-medium text-white",children:"Quick"}),(0,n.jsx)("span",{className:"text-xs text-white opacity-90",children:"20 sec"})]}),(0,n.jsxs)("button",{onClick:()=>x(s.BreakType.SHORT),className:"flex flex-col items-center p-2 bg-gradient-to-br from-green-400 to-emerald-500 hover:from-green-500 hover:to-emerald-600 rounded border border-emerald-400 transition-all duration-200 hover:shadow-md text-white",children:[(0,n.jsx)("span",{className:"text-lg mb-1",children:"👁️"}),(0,n.jsx)("span",{className:"text-xs font-medium text-white",children:"Eye Break"}),(0,n.jsx)("span",{className:"text-xs text-white opacity-90",children:"5 min"})]}),(0,n.jsxs)("button",{onClick:()=>x(s.BreakType.LONG),className:"flex flex-col items-center p-2 bg-gradient-to-br from-purple-400 to-indigo-500 hover:from-purple-500 hover:to-indigo-600 rounded border border-indigo-400 transition-all duration-200 hover:shadow-md text-white",children:[(0,n.jsx)("span",{className:"text-lg mb-1",children:"🧘"}),(0,n.jsx)("span",{className:"text-xs font-medium text-white",children:"Wellness"}),(0,n.jsx)("span",{className:"text-xs text-white opacity-90",children:"15 min"})]})]})]}),(0,n.jsxs)("button",{onClick:()=>{a.isLoggedIn?r():l(e=>({...e,showLoginModal:!0}))},className:"w-full mt-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors flex items-center justify-center space-x-2",children:[!a.isLoggedIn&&(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})}),(0,n.jsx)("span",{children:a.isLoggedIn?"View detailed dashboard →":"Login to view dashboard →"})]})]}),(0,n.jsx)(o.Suspense,{fallback:(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,n.jsx)(m,{isOpen:a.isModalOpen,breakType:a.selectedBreakType,onClose:()=>{l(e=>({...e,isModalOpen:!1,selectedBreakType:null}))},onStartBreak:e})}),(0,n.jsx)(o.Suspense,{fallback:(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,n.jsx)(u,{isVisible:a.showReminderModal,onClose:()=>l(e=>({...e,showReminderModal:!1})),onSetReminder:async e=>{try{await chrome.alarms.clear("eyezen_break_reminder"),await chrome.alarms.clear("break-reminder"),await chrome.alarms.create("break-reminder",{delayInMinutes:e,periodInMinutes:e}),console.log("Break reminder set for every",e,"minutes"),await chrome.storage.local.set({eyezen_reminder:{isActive:!0,interval:e,setAt:Date.now()}}),console.log("Reminder settings saved:",{isActive:!0,interval:e,setAt:Date.now()}),l(r=>({...r,isReminderActive:!0,reminderInterval:e,showReminderModal:!1})),console.log(`Break reminder set for every ${e} minutes`)}catch(e){console.error("Failed to set reminder:",e),alert("Failed to set reminder. Please try again.")}},onClearReminder:async()=>{try{await chrome.alarms.clear("eyezen_break_reminder"),await chrome.alarms.clear("break-reminder"),await chrome.storage.local.remove(["eyezen_reminder"]),l(e=>({...e,isReminderActive:!1,showReminderModal:!1})),console.log("Break reminder cleared")}catch(e){console.error("Failed to clear reminder:",e)}},isReminderActive:a.isReminderActive,currentInterval:a.reminderInterval})})]})]})};document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("popup-root");if(e){e.innerHTML="";try{const r=(0,a.createRoot)(e),t=e=>{chrome.runtime.sendMessage({action:"START_BREAK",breakType:e},e=>{e?.success?window.close():console.error("Failed to start break:",e?.error)})},o=()=>{chrome.runtime.openOptionsPage(),window.close()};r.render((0,n.jsx)(p,{onStartBreak:t,onOpenSettings:o}))}catch(r){console.error("Failed to initialize popup React root:",r),e.innerHTML='\n      <div style="padding: 20px; text-align: center; color: red;">\n        <h3>Failed to load popup</h3>\n        <p>Please try reloading the extension.</p>\n      </div>\n    '}}else console.error("Popup root element not found")}),window.addEventListener("error",e=>{console.error("Popup error:",e.error)}),window.addEventListener("unhandledrejection",e=>{console.error("Popup unhandled promise rejection:",e.reason)})},463:(e,r)=>{function t(e,r){var t=e.length;e.push(r);e:for(;0<t;){var n=t-1>>>1,a=e[n];if(!(0<o(a,r)))break e;e[n]=r,e[t]=a,t=n}}function n(e){return 0===e.length?null:e[0]}function a(e){if(0===e.length)return null;var r=e[0],t=e.pop();if(t!==r){e[0]=t;e:for(var n=0,a=e.length,s=a>>>1;n<s;){var i=2*(n+1)-1,l=e[i],c=i+1,d=e[c];if(0>o(l,t))c<a&&0>o(d,l)?(e[n]=d,e[c]=t,n=c):(e[n]=l,e[i]=t,n=i);else{if(!(c<a&&0>o(d,t)))break e;e[n]=d,e[c]=t,n=c}}}return r}function o(e,r){var t=e.sortIndex-r.sortIndex;return 0!==t?t:e.id-r.id}if("object"==typeof performance&&"function"==typeof performance.now){var s=performance;r.unstable_now=function(){return s.now()}}else{var i=Date,l=i.now();r.unstable_now=function(){return i.now()-l}}var c=[],d=[],m=1,u=null,h=3,g=!1,p=!1,f=!1,y="function"==typeof setTimeout?setTimeout:null,w="function"==typeof clearTimeout?clearTimeout:null,b="undefined"!=typeof setImmediate?setImmediate:null;function v(e){for(var r=n(d);null!==r;){if(null===r.callback)a(d);else{if(!(r.startTime<=e))break;a(d),r.sortIndex=r.expirationTime,t(c,r)}r=n(d)}}function x(e){if(f=!1,v(e),!p)if(null!==n(c))p=!0,L(k);else{var r=n(d);null!==r&&R(x,r.startTime-e)}}function k(e,t){p=!1,f&&(f=!1,w(E),E=-1),g=!0;var o=h;try{for(v(t),u=n(c);null!==u&&(!(u.expirationTime>t)||e&&!N());){var s=u.callback;if("function"==typeof s){u.callback=null,h=u.priorityLevel;var i=s(u.expirationTime<=t);t=r.unstable_now(),"function"==typeof i?u.callback=i:u===n(c)&&a(c),v(t)}else a(c);u=n(c)}if(null!==u)var l=!0;else{var m=n(d);null!==m&&R(x,m.startTime-t),l=!1}return l}finally{u=null,h=o,g=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var C,S=!1,P=null,E=-1,j=5,I=-1;function N(){return!(r.unstable_now()-I<j)}function A(){if(null!==P){var e=r.unstable_now();I=e;var t=!0;try{t=P(!0,e)}finally{t?C():(S=!1,P=null)}}else S=!1}if("function"==typeof b)C=function(){b(A)};else if("undefined"!=typeof MessageChannel){var _=new MessageChannel,M=_.port2;_.port1.onmessage=A,C=function(){M.postMessage(null)}}else C=function(){y(A,0)};function L(e){P=e,S||(S=!0,C())}function R(e,t){E=y(function(){e(r.unstable_now())},t)}r.unstable_IdlePriority=5,r.unstable_ImmediatePriority=1,r.unstable_LowPriority=4,r.unstable_NormalPriority=3,r.unstable_Profiling=null,r.unstable_UserBlockingPriority=2,r.unstable_cancelCallback=function(e){e.callback=null},r.unstable_continueExecution=function(){p||g||(p=!0,L(k))},r.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):j=0<e?Math.floor(1e3/e):5},r.unstable_getCurrentPriorityLevel=function(){return h},r.unstable_getFirstCallbackNode=function(){return n(c)},r.unstable_next=function(e){switch(h){case 1:case 2:case 3:var r=3;break;default:r=h}var t=h;h=r;try{return e()}finally{h=t}},r.unstable_pauseExecution=function(){},r.unstable_requestPaint=function(){},r.unstable_runWithPriority=function(e,r){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var t=h;h=e;try{return r()}finally{h=t}},r.unstable_scheduleCallback=function(e,a,o){var s=r.unstable_now();switch(o="object"==typeof o&&null!==o&&"number"==typeof(o=o.delay)&&0<o?s+o:s,e){case 1:var i=-1;break;case 2:i=250;break;case 5:i=1073741823;break;case 4:i=1e4;break;default:i=5e3}return e={id:m++,callback:a,priorityLevel:e,startTime:o,expirationTime:i=o+i,sortIndex:-1},o>s?(e.sortIndex=o,t(d,e),null===n(c)&&e===n(d)&&(f?(w(E),E=-1):f=!0,R(x,o-s))):(e.sortIndex=i,t(c,e),p||g||(p=!0,L(k))),e},r.unstable_shouldYield=N,r.unstable_wrapCallback=function(e){var r=h;return function(){var t=h;h=r;try{return e.apply(this,arguments)}finally{h=t}}}},982:(e,r,t)=>{e.exports=t(463)}},a={};function o(e){var r=a[e];if(void 0!==r)return r.exports;var t=a[e]={exports:{}};return n[e](t,t.exports,o),t.exports}o.m=n,e=[],o.O=(r,t,n,a)=>{if(!t){var s=1/0;for(d=0;d<e.length;d++){for(var[t,n,a]=e[d],i=!0,l=0;l<t.length;l++)(!1&a||s>=a)&&Object.keys(o.O).every(e=>o.O[e](t[l]))?t.splice(l--,1):(i=!1,a<s&&(s=a));if(i){e.splice(d--,1);var c=n();void 0!==c&&(r=c)}}return r}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[t,n,a]},o.d=(e,r)=>{for(var t in r)o.o(r,t)&&!o.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce((r,t)=>(o.f[t](e,r),r),[])),o.u=e=>e+".js",o.miniCssF=e=>{},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),r={},t="eyezen-chrome-extension:",o.l=(e,n,a,s)=>{if(r[e])r[e].push(n);else{var i,l;if(void 0!==a)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var m=c[d];if(m.getAttribute("src")==e||m.getAttribute("data-webpack")==t+a){i=m;break}}i||(l=!0,(i=document.createElement("script")).charset="utf-8",i.timeout=120,o.nc&&i.setAttribute("nonce",o.nc),i.setAttribute("data-webpack",t+a),i.src=e),r[e]=[n];var u=(t,n)=>{i.onerror=i.onload=null,clearTimeout(h);var a=r[e];if(delete r[e],i.parentNode&&i.parentNode.removeChild(i),a&&a.forEach(e=>e(n)),t)return t(n)},h=setTimeout(u.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=u.bind(null,i.onerror),i.onload=u.bind(null,i.onload),l&&document.head.appendChild(i)}},o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var r=o.g.document;if(!e&&r&&(r.currentScript&&"SCRIPT"===r.currentScript.tagName.toUpperCase()&&(e=r.currentScript.src),!e)){var t=r.getElementsByTagName("script");if(t.length)for(var n=t.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=t[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e})(),(()=>{var e={887:0,820:0};o.f.j=(r,t)=>{var n=o.o(e,r)?e[r]:void 0;if(0!==n)if(n)t.push(n[2]);else if(820!=r){var a=new Promise((t,a)=>n=e[r]=[t,a]);t.push(n[2]=a);var s=o.p+o.u(r),i=new Error;o.l(s,t=>{if(o.o(e,r)&&(0!==(n=e[r])&&(e[r]=void 0),n)){var a=t&&("load"===t.type?"missing":t.type),s=t&&t.target&&t.target.src;i.message="Loading chunk "+r+" failed.\n("+a+": "+s+")",i.name="ChunkLoadError",i.type=a,i.request=s,n[1](i)}},"chunk-"+r,r)}else e[r]=0},o.O.j=r=>0===e[r];var r=(r,t)=>{var n,a,[s,i,l]=t,c=0;if(s.some(r=>0!==e[r])){for(n in i)o.o(i,n)&&(o.m[n]=i[n]);if(l)var d=l(o)}for(r&&r(t);c<s.length;c++)a=s[c],o.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return o.O(d)},t=self.webpackChunkeyezen_chrome_extension=self.webpackChunkeyezen_chrome_extension||[];t.forEach(r.bind(null,0)),t.push=r.bind(null,t.push.bind(t))})();var s=o.O(void 0,[644,123,820],()=>o(455));s=o.O(s)})();