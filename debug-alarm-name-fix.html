<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EyeZen - Alarm Name Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.danger {
            background: #f44336;
        }
        .button.danger:hover {
            background: #da190b;
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-entry.info { color: #2196F3; }
        .log-entry.success { color: #4CAF50; }
        .log-entry.error { color: #f44336; }
        .log-entry.warning { color: #FF9800; }
        h1 { color: #333; }
        h2 { color: #666; margin-top: 30px; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 EyeZen Alarm Name Fix Test</h1>
        <p>This page tests the alarm name fix where we changed from 'eyezen_break_reminder' to 'break-reminder' to match the service worker.</p>
        
        <div class="status success">
            <strong>✅ Fix Applied:</strong> Updated popup and reminder modal to use 'break-reminder' alarm name
        </div>

        <h2>🧪 Test Controls</h2>
        <button class="button" onclick="checkCurrentAlarms()">📋 List All Alarms</button>
        <button class="button" onclick="clearAllAlarms()">🧹 Clear All Alarms</button>
        <button class="button" onclick="createTestAlarm()">⏰ Create Test Alarm (2 min)</button>
        <button class="button" onclick="testServiceWorkerCommunication()">🔧 Test Service Worker</button>
        <button class="button danger" onclick="clearLogs()">🗑️ Clear Logs</button>

        <h2>📊 Test Results</h2>
        <div id="logContainer" class="log"></div>

        <h2>📝 Expected Behavior</h2>
        <ul>
            <li>Alarms should be created with name 'break-reminder'</li>
            <li>Service worker should handle 'break-reminder' alarms</li>
            <li>Notifications should appear when alarms trigger</li>
            <li>Remaining time display should work correctly</li>
        </ul>
    </div>

    <script>
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function checkCurrentAlarms() {
            try {
                log('🔍 Checking current alarms...', 'info');
                const alarms = await chrome.alarms.getAll();
                
                if (alarms.length === 0) {
                    log('❌ No alarms found', 'warning');
                } else {
                    log(`✅ Found ${alarms.length} alarm(s):`, 'success');
                    alarms.forEach(alarm => {
                        const nextTrigger = new Date(alarm.scheduledTime).toLocaleString();
                        log(`  - ${alarm.name}: Next at ${nextTrigger}, Period: ${alarm.periodInMinutes || 'N/A'} min`, 'info');
                    });
                }
            } catch (error) {
                log(`❌ Error checking alarms: ${error.message}`, 'error');
            }
        }

        async function clearAllAlarms() {
            try {
                log('🧹 Clearing all alarms...', 'info');
                const clearedCount = await chrome.alarms.clearAll();
                log(`✅ Cleared ${clearedCount} alarm(s)`, 'success');
                setTimeout(checkCurrentAlarms, 500);
            } catch (error) {
                log(`❌ Error clearing alarms: ${error.message}`, 'error');
            }
        }

        async function createTestAlarm() {
            try {
                log('⏰ Creating test alarm with correct name...', 'info');
                
                // Clear any existing alarms first
                await chrome.alarms.clearAll();
                log('🧹 Cleared existing alarms', 'info');
                
                // Create alarm with the correct name that matches service worker
                await chrome.alarms.create('break-reminder', {
                    delayInMinutes: 2,
                    periodInMinutes: 2
                });
                
                log('✅ Created break-reminder alarm (2 minute interval)', 'success');
                log('⏳ Alarm should trigger in 2 minutes...', 'info');
                
                setTimeout(checkCurrentAlarms, 500);
            } catch (error) {
                log(`❌ Error creating test alarm: ${error.message}`, 'error');
            }
        }

        async function testServiceWorkerCommunication() {
            try {
                log('🔧 Testing service worker communication...', 'info');
                
                // Test basic communication
                const response = await chrome.runtime.sendMessage({ 
                    action: 'GET_STATUS' 
                });
                
                if (response) {
                    log(`✅ Service worker responded: ${JSON.stringify(response)}`, 'success');
                } else {
                    log('⚠️ Service worker responded but with no data', 'warning');
                }
                
                // Test alarm recreation
                log('🔄 Requesting alarm recreation...', 'info');
                const updateResponse = await chrome.runtime.sendMessage({
                    action: 'updateSettings',
                    settings: { reminderEnabled: true, reminderInterval: 2 }
                });
                
                log(`✅ Settings update response: ${JSON.stringify(updateResponse)}`, 'success');
                
                setTimeout(checkCurrentAlarms, 1000);
            } catch (error) {
                log(`❌ Service worker communication error: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            log('🗑️ Logs cleared', 'info');
        }

        // Listen for alarm events
        if (chrome && chrome.alarms) {
            chrome.alarms.onAlarm.addListener((alarm) => {
                log(`🚨 ALARM TRIGGERED: ${alarm.name} at ${new Date().toLocaleString()}`, 'success');
                log(`🔔 This should now trigger a notification!`, 'success');
            });
            log('👂 Alarm listener registered', 'info');
        }

        // Initialize
        log('🚀 Alarm name fix test page loaded', 'info');
        log('🔧 Testing the fix for alarm name mismatch issue', 'info');
        checkCurrentAlarms();
    </script>
</body>
</html>