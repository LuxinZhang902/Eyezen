(()=>{"use strict";var e,t={520:(e,t,r)=>{r.r(t),r.d(t,{default:()=>u});var a=r(123),o=r(235);const s="break-reminder",n="daily-summary",i="posture-check",c=20,l=30,m=1440,d=new class{constructor(){this.isInitialized=!1,this.activeBreakTabId=null}async initialize(){if(!this.isInitialized)try{chrome.alarms.onAlarm.addListener(this.handleAlarm.bind(this)),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),chrome.runtime.onInstalled.addListener(this.handleInstall.bind(this)),chrome.runtime.onStartup.addListener(this.handleStartup.bind(this)),chrome.tabs.onRemoved.addListener(this.handleTabRemoved.bind(this)),await this.setupDefaultAlarms(),this.isInitialized=!0,console.log("EyeZen Background Service initialized")}catch(e){console.error("Failed to initialize background service:",e)}}async handleAlarm(e){console.log("Alarm triggered:",e.name);try{switch(e.name){case s:await this.handleBreakReminder();break;case i:await this.handlePostureCheck();break;case n:await this.handleDailySummary();break;case"weekly-summary":await this.handleWeeklySummary();break;default:console.log("Unknown alarm:",e.name)}}catch(t){console.error("Error handling alarm:",e.name,t)}}async handleMessage(e,t,r){"REQUEST_CAMERA"!==e.type&&"STOP_CAMERA"!==e.type&&"GET_CAMERA_STATE"!==e.type&&console.log("üîÑ Service Worker received message:",e.type||e.action,"from:",t.tab?.url||"extension");try{if("REQUEST_CAMERA"===e.type||"STOP_CAMERA"===e.type||"GET_CAMERA_STATE"===e.type)return this.forwardToOffscreenDocument(e,r),!0;if("EYE_METRICS"===e.type)return console.log("üëÅÔ∏è Service Worker: Forwarding eye metrics to popup"),chrome.runtime.sendMessage(e).catch(()=>{}),r({success:!0}),!1;switch(e.action){case"START_BREAK":console.log("üõë Service Worker: Starting break:",e.breakType),await this.startBreak(e.breakType),r({success:!0});break;case"END_BREAK":console.log("‚úÖ Service Worker: Ending break:",e.breakId),await this.endBreak(e.breakId),r({success:!0});break;case"UPDATE_SETTINGS":console.log("‚öôÔ∏è Service Worker: Updating settings"),await this.updateSettings(e.settings),r({success:!0});break;case"GET_STATUS":const t=await this.getStatus();console.log("üìä Service Worker: Returning status"),r({success:!0,data:t});break;case"SNOOZE_REMINDER":console.log("üò¥ Service Worker: Snoozing reminder for",e.minutes||5,"minutes"),await this.snoozeReminder(e.minutes||5),r({success:!0});break;default:console.warn("‚ùì Service Worker: Unknown action:",e.action||e.type),r({success:!1,error:"Unknown action"})}}catch(e){console.error("‚ùå Service Worker: Error handling message:",e),r({success:!1,error:String(e)})}return!1}async handleInstall(e){"install"===e.reason?(console.log("EyeZen installed for the first time"),await this.setupInitialData(),await this.showNotification({type:"basic",iconUrl:"assets/icons/icon-48.svg",title:"Welcome to EyeZen! üëÅÔ∏è",message:"Your AI eye health companion is ready. Click to get started!"})):"update"===e.reason&&console.log("EyeZen updated to version:",chrome.runtime.getManifest().version)}async handleStartup(){console.log("EyeZen service worker started"),await this.setupDefaultAlarms()}async handleTabRemoved(e){this.activeBreakTabId===e&&(this.activeBreakTabId=null,console.log("Break tab closed"))}async setupDefaultAlarms(){try{const e=await a.ChromeStorageService.getUserData(),t=e?.settings||o.DEFAULT_SETTINGS;if(await chrome.alarms.clearAll(),t.reminderEnabled??1){const e=t.reminderInterval??c;await chrome.alarms.create(s,{delayInMinutes:e,periodInMinutes:e})}(t.reminderEnabled??1)&&await chrome.alarms.create(i,{delayInMinutes:l,periodInMinutes:l});const r=new Date,d=new Date;d.setHours(20,0,0,0),d<=r&&d.setDate(d.getDate()+1),await chrome.alarms.create(n,{when:d.getTime(),periodInMinutes:m}),console.log("Default alarms set up successfully")}catch(e){console.error("Failed to setup default alarms:",e)}}async handleBreakReminder(){try{const e=await a.ChromeStorageService.getUserData();if(!e||!e.settings.reminderEnabled)return;if(e.breaks.find(e=>!e.completed))return void console.log("User is already in a break, skipping reminder");const t=e.metrics.slice(-5),r=t.reduce((e,t)=>e+(t.fatigueIndex||0),0)/t.length;let o="üëÅÔ∏è Time for an Eye Break!",s="Follow the 20-20-20 rule: Look at something 20 feet away for 20 seconds.",n=0;r>.7?(o="‚ö†Ô∏è High Eye Strain Detected!",s="Your eyes need immediate rest. Take a break now to prevent fatigue.",n=2):r>.5&&(o="üò¥ Eyes Getting Tired",s="Time for a refreshing eye break. Your future self will thank you!",n=1),await this.showNotification({type:"basic",iconUrl:"assets/icons/icon-48.svg",title:o,message:s,priority:n,buttons:[{title:"Start Break"},{title:"Snooze 5min"}]})}catch(e){console.error("Error in break reminder:",e)}}async handlePostureCheck(){try{const e=await a.ChromeStorageService.getUserData();if(!e||!e.settings.reminderEnabled)return;await this.showNotification({type:"basic",iconUrl:"assets/icons/icon-48.svg",title:"üßò Posture Check",message:"Sit up straight, relax your shoulders, and adjust your screen height.",priority:0})}catch(e){console.error("Error in posture check:",e)}}async handleDailySummary(){try{const e=await a.ChromeStorageService.getUserData();if(!e)return;const t=new Date;t.setHours(0,0,0,0);const r=e.metrics.filter(e=>{const r=new Date(e.timestamp);return r.setHours(0,0,0,0),r.getTime()===t.getTime()}),o=e.breaks.filter(e=>{const r=new Date(e.startTime);return r.setHours(0,0,0,0),r.getTime()===t.getTime()&&e.completed}),s=r.length>0?r.reduce((e,t)=>e+(100-100*(t.fatigueIndex||0)),0)/r.length:50;await this.showNotification({type:"basic",iconUrl:"assets/icons/icon-48.svg",title:"üìä Daily Eye Health Summary",message:`Eye Health Score: ${Math.round(s)}/100 | Breaks Taken: ${o.length}`,priority:0})}catch(e){console.error("Error in daily summary:",e)}}async handleWeeklySummary(){try{await this.showNotification({type:"basic",iconUrl:"assets/icons/icon-48.svg",title:"üìà Weekly Eye Health Report",message:"Your weekly eye health report is ready! Click to view insights.",priority:1})}catch(e){console.error("Error in weekly summary:",e)}}async startBreak(e){try{const t=Date.now().toString(),r={id:t,type:e,duration:e===o.BreakType.MICRO?20:e===o.BreakType.SHORT?300:900,startTime:Date.now(),completed:!1,activities:[]},s=await a.ChromeStorageService.getUserData();s&&(s.breaks.push(r),await a.ChromeStorageService.saveUserData(s));const n=chrome.runtime.getURL(`break-ritual.html?type=${e}&id=${t}`),i=await chrome.tabs.create({url:n});this.activeBreakTabId=i.id||null,console.log("Break started:",e,t)}catch(e){throw console.error("Error starting break:",e),e}}async endBreak(e){try{const t=await a.ChromeStorageService.getUserData();if(t){const r=t.breaks.findIndex(t=>t.id===e);-1!==r&&(t.breaks[r].completed=!0,t.breaks[r].endTime=Date.now(),await a.ChromeStorageService.saveUserData(t))}console.log("Break completed:",e)}catch(e){throw console.error("Error ending break:",e),e}}async updateSettings(e){try{await a.ChromeStorageService.updateSettings(e),await this.setupDefaultAlarms(),console.log("Settings updated:",e)}catch(e){throw console.error("Error updating settings:",e),e}}async getStatus(){try{const e=await a.ChromeStorageService.getUserData();return{isActive:!0,settings:e?.settings||{},lastBreak:e?.breaks.slice(-1)[0]||null,todayMetrics:e?.metrics.filter(e=>{const t=new Date;t.setHours(0,0,0,0);const r=new Date(e.timestamp);return r.setHours(0,0,0,0),r.getTime()===t.getTime()})||[]}}catch(e){throw console.error("Error getting status:",e),e}}async snoozeReminder(e){try{await chrome.alarms.clear(s),await chrome.alarms.create(s,{delayInMinutes:e}),console.log(`Break reminder snoozed for ${e} minutes`)}catch(e){throw console.error("Error snoozing reminder:",e),e}}async ensureOffscreenDocument(){console.log("üîç Checking for existing offscreen document...");const e=await chrome.runtime.getContexts({});console.log("üìã All existing contexts:",e);const t=e.find(e=>"OFFSCREEN_DOCUMENT"===e.contextType);t?console.log("‚úÖ Offscreen document already exists:",t):(console.log("üìÑ No offscreen document found, creating new one..."),await chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Camera access for eye health monitoring"}),console.log("‚úÖ Offscreen document created successfully"))}async forwardToOffscreenDocument(e,t){console.log("üöÄ forwardToOffscreenDocument called with message:",e);try{console.log("üìÑ Ensuring offscreen document exists..."),await this.ensureOffscreenDocument(),console.log("‚úÖ Offscreen document ensured"),console.log("‚è≥ Waiting 500ms for offscreen document to be ready..."),await new Promise(e=>setTimeout(e,500)),console.log("‚úÖ Wait completed, sending message to offscreen document"),console.log("üì§ Sending message to offscreen document:",e),chrome.runtime.sendMessage(e,e=>{console.log("üì• Received response from offscreen document:",e),console.log("üîç Chrome runtime last error:",chrome.runtime.lastError),chrome.runtime.lastError?(console.error("‚ùå Error communicating with offscreen document:",chrome.runtime.lastError),t({success:!1,error:chrome.runtime.lastError.message})):(console.log("‚úÖ Forwarding response back to popup:",e),t(e))})}catch(e){console.error("‚ùå Error in forwardToOffscreenDocument:",e),t({success:!1,error:e instanceof Error?e.message:String(e)})}}async setupInitialData(){try{const e={settings:{cameraEnabled:!0,detectionSensitivity:"medium",fatigueThreshold:70,reminderEnabled:!0,reminderInterval:20,breakDuration:20,dataRetention:30,metricsOnly:!1,language:"en",theme:"light",notifications:!0,sounds:!0,dailyBreakGoal:8,eyeScoreGoal:80},metrics:[],breaks:[],events:[],score:{current:50,daily:50,weekly:50,trend:"stable"},lastUpdated:Date.now()};await a.ChromeStorageService.saveUserData(e),console.log("Initial data setup completed")}catch(e){console.error("Error setting up initial data:",e)}}async showNotification(e){try{const t=`eyezen-${Date.now()}`,r={type:"basic",iconUrl:"assets/icons/icon-48.svg",title:"EyeZen",message:"",priority:0,...e},a={type:"basic",iconUrl:r.iconUrl||"assets/icons/icon-48.svg",title:r.title||"EyeZen",message:r.message||""};r.buttons&&(a.buttons=r.buttons),await chrome.notifications.create(t,a),0===(e.priority||0)&&setTimeout(()=>{chrome.notifications.clear(t)},1e4)}catch(e){console.error("Error showing notification:",e)}}};d.initialize(),chrome.notifications.onClicked.addListener(e=>{e.startsWith("eyezen-")&&(chrome.action.openPopup(),chrome.notifications.clear(e))}),chrome.notifications.onButtonClicked.addListener((e,t)=>{e.startsWith("eyezen-")&&(0===t?d.initialize().then(()=>{chrome.runtime.sendMessage({action:"START_BREAK",breakType:o.BreakType.SHORT})}):1===t&&d.initialize().then(()=>{chrome.runtime.sendMessage({action:"SNOOZE_REMINDER",minutes:5})}),chrome.notifications.clear(e))});const u=d}},r={};function a(e){var o=r[e];if(void 0!==o)return o.exports;var s=r[e]={exports:{}};return t[e](s,s.exports,a),s.exports}a.m=t,e=[],a.O=(t,r,o,s)=>{if(!r){var n=1/0;for(m=0;m<e.length;m++){for(var[r,o,s]=e[m],i=!0,c=0;c<r.length;c++)(!1&s||n>=s)&&Object.keys(a.O).every(e=>a.O[e](r[c]))?r.splice(c--,1):(i=!1,s<n&&(n=s));if(i){e.splice(m--,1);var l=o();void 0!==l&&(t=l)}}return t}s=s||0;for(var m=e.length;m>0&&e[m-1][2]>s;m--)e[m]=e[m-1];e[m]=[r,o,s]},a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e={471:0};a.O.j=t=>0===e[t];var t=(t,r)=>{var o,s,[n,i,c]=r,l=0;if(n.some(t=>0!==e[t])){for(o in i)a.o(i,o)&&(a.m[o]=i[o]);if(c)var m=c(a)}for(t&&t(r);l<n.length;l++)s=n[l],a.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return a.O(m)},r=self.webpackChunkeyezen_chrome_extension=self.webpackChunkeyezen_chrome_extension||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var o=a.O(void 0,[123],()=>a(520));o=a.O(o)})();