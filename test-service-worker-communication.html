<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Communication Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
        }
        .instructions {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Service Worker Communication Test</h1>
        
        <div class="instructions">
            <h3>‚ö†Ô∏è Important: How to Use This Test</h3>
            <p><strong>This test must be opened as an extension page, not a regular file.</strong></p>
            <ol>
                <li>Copy this file to your <code>dist/</code> folder</li>
                <li>Add it to your manifest.json web_accessible_resources</li>
                <li>Open it via: <code>chrome-extension://[your-extension-id]/test-service-worker-communication.html</code></li>
            </ol>
            <p><strong>Alternative:</strong> Open your extension popup and paste the test code in the console.</p>
        </div>
        
        <div id="context-check"></div>
        
        <div class="test-section">
            <h3>1. Basic Service Worker Test</h3>
            <button onclick="testBasicMessage()">Test Basic Message</button>
            <button onclick="testPopupMessage()">Test POPUP_TEST Message</button>
            <button onclick="testSettingsMessage()">Test SETTINGS_UPDATED Message</button>
        </div>
        
        <div class="test-section">
            <h3>2. Storage-Based Communication Test</h3>
            <p>This test stores results in chrome.storage to verify if the service worker is working even if console logs don't show.</p>
            <button onclick="testStorageBasedCommunication()">Test Storage Communication</button>
            <button onclick="checkStorageResults()">Check Storage Results</button>
            <button onclick="clearStorageResults()">Clear Storage Results</button>
        </div>
        
        <div class="test-section">
            <h3>3. Extension Status Check</h3>
            <button onclick="checkExtensionStatus()">Check Extension Status</button>
            <button onclick="checkAlarms()">Check Active Alarms</button>
        </div>
        
        <div class="test-section">
            <h3>4. Console Test Code</h3>
            <p>If you can't access this as an extension page, copy and paste this code in your extension popup's console:</p>
            <button onclick="showConsoleCode()">Show Console Test Code</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function logObject(obj, title) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.innerHTML = `<h4>${title}</h4><pre>${JSON.stringify(obj, null, 2)}</pre>`;
            results.appendChild(div);
        }

        function checkExtensionContext() {
            const contextCheck = document.getElementById('context-check');
            
            if (typeof chrome === 'undefined') {
                contextCheck.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>Chrome Extension API not available</strong><br>
                        This page is not running in an extension context. Please follow the instructions above.
                    </div>
                `;
                return false;
            }
            
            if (!chrome.runtime) {
                contextCheck.innerHTML = `
                    <div class="status error">
                        ‚ùå <strong>Chrome Runtime API not available</strong><br>
                        Extension context detected but runtime API is missing.
                    </div>
                `;
                return false;
            }
            
            contextCheck.innerHTML = `
                <div class="status success">
                    ‚úÖ <strong>Extension context detected!</strong><br>
                    Extension ID: ${chrome.runtime.id || 'Unknown'}
                </div>
            `;
            return true;
        }

        async function testBasicMessage() {
            if (!checkExtensionContext()) return;
            
            log('Testing basic service worker message...', 'info');
            
            try {
                const response = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Message timeout after 5 seconds'));
                    }, 5000);
                    
                    chrome.runtime.sendMessage({
                        action: 'GET_STATUS'
                    }, (response) => {
                        clearTimeout(timeout);
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                log('‚úÖ Basic message successful!', 'success');
                logObject(response, 'Service Worker Response');
                
            } catch (error) {
                log(`‚ùå Basic message failed: ${error.message}`, 'error');
                
                if (error.message.includes('Could not establish connection')) {
                    log('üîç Service worker is not running or not responding', 'warning');
                } else if (error.message.includes('timeout')) {
                    log('üîç Service worker is taking too long to respond', 'warning');
                }
            }
        }

        async function testPopupMessage() {
            if (!checkExtensionContext()) return;
            
            log('Testing POPUP_TEST message...', 'info');
            
            try {
                const response = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Message timeout after 5 seconds'));
                    }, 5000);
                    
                    chrome.runtime.sendMessage({
                        type: 'POPUP_TEST',
                        data: { test: true, timestamp: Date.now() }
                    }, (response) => {
                        clearTimeout(timeout);
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                log('‚úÖ POPUP_TEST message successful!', 'success');
                logObject(response, 'POPUP_TEST Response');
                
            } catch (error) {
                log(`‚ùå POPUP_TEST message failed: ${error.message}`, 'error');
            }
        }

        async function testSettingsMessage() {
            if (!checkExtensionContext()) return;
            
            log('Testing SETTINGS_UPDATED message...', 'info');
            
            try {
                const response = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Message timeout after 5 seconds'));
                    }, 5000);
                    
                    chrome.runtime.sendMessage({
                        type: 'SETTINGS_UPDATED',
                        data: {
                            settings: {
                                reminderEnabled: true,
                                reminderInterval: 0.5,
                                notifications: true
                            }
                        }
                    }, (response) => {
                        clearTimeout(timeout);
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                log('‚úÖ SETTINGS_UPDATED message successful!', 'success');
                logObject(response, 'SETTINGS_UPDATED Response');
                
            } catch (error) {
                log(`‚ùå SETTINGS_UPDATED message failed: ${error.message}`, 'error');
            }
        }

        async function testStorageBasedCommunication() {
            if (!checkExtensionContext()) return;
            
            log('Testing storage-based communication...', 'info');
            
            try {
                // Clear previous test results
                await chrome.storage.local.remove(['sw_test_results']);
                
                // Send a message that should trigger the service worker to store a result
                const testId = `test_${Date.now()}`;
                
                chrome.runtime.sendMessage({
                    action: 'UPDATE_SETTINGS',
                    settings: {
                        reminderEnabled: true,
                        reminderInterval: 0.5,
                        notifications: true,
                        testId: testId // Add test ID to track this specific test
                    }
                }, async (response) => {
                    if (chrome.runtime.lastError) {
                        log(`‚ùå Storage test message failed: ${chrome.runtime.lastError.message}`, 'error');
                        return;
                    }
                    
                    log('‚úÖ Storage test message sent, checking results...', 'info');
                    
                    // Wait a moment for the service worker to process
                    setTimeout(async () => {
                        try {
                            const result = await chrome.storage.local.get(['sw_test_results']);
                            if (result.sw_test_results) {
                                log('‚úÖ Service worker stored test results!', 'success');
                                logObject(result.sw_test_results, 'Storage Test Results');
                            } else {
                                log('‚ö†Ô∏è No test results found in storage', 'warning');
                            }
                        } catch (error) {
                            log(`‚ùå Error checking storage results: ${error.message}`, 'error');
                        }
                    }, 2000);
                });
                
            } catch (error) {
                log(`‚ùå Storage test failed: ${error.message}`, 'error');
            }
        }

        async function checkStorageResults() {
            if (!checkExtensionContext()) return;
            
            log('Checking storage for service worker test results...', 'info');
            
            try {
                const result = await chrome.storage.local.get(null); // Get all storage
                logObject(result, 'All Chrome Storage Contents');
                
                if (Object.keys(result).length === 0) {
                    log('‚ö†Ô∏è Chrome storage is empty', 'warning');
                } else {
                    log(`‚úÖ Found ${Object.keys(result).length} items in storage`, 'success');
                }
                
            } catch (error) {
                log(`‚ùå Error checking storage: ${error.message}`, 'error');
            }
        }

        async function clearStorageResults() {
            if (!checkExtensionContext()) return;
            
            log('Clearing storage results...', 'info');
            
            try {
                await chrome.storage.local.clear();
                log('‚úÖ Storage cleared successfully', 'success');
            } catch (error) {
                log(`‚ùå Error clearing storage: ${error.message}`, 'error');
            }
        }

        async function checkExtensionStatus() {
            if (!checkExtensionContext()) return;
            
            log('Checking extension status...', 'info');
            
            try {
                const manifest = chrome.runtime.getManifest();
                logObject({
                    name: manifest.name,
                    version: manifest.version,
                    manifest_version: manifest.manifest_version,
                    background: manifest.background,
                    permissions: manifest.permissions
                }, 'Extension Manifest');
                
                log(`‚úÖ Extension ID: ${chrome.runtime.id}`, 'success');
                
            } catch (error) {
                log(`‚ùå Error checking extension status: ${error.message}`, 'error');
            }
        }

        async function checkAlarms() {
            if (!checkExtensionContext()) return;
            
            log('Checking active alarms...', 'info');
            
            try {
                const alarms = await chrome.alarms.getAll();
                
                if (alarms.length === 0) {
                    log('‚ö†Ô∏è No active alarms found', 'warning');
                } else {
                    log(`‚úÖ Found ${alarms.length} active alarms`, 'success');
                    
                    const alarmInfo = alarms.map(alarm => ({
                        name: alarm.name,
                        scheduledTime: new Date(alarm.scheduledTime).toLocaleString(),
                        periodInMinutes: alarm.periodInMinutes
                    }));
                    
                    logObject(alarmInfo, 'Active Alarms');
                }
                
            } catch (error) {
                log(`‚ùå Error checking alarms: ${error.message}`, 'error');
            }
        }

        function showConsoleCode() {
            const consoleCode = `
// Copy and paste this code in your extension popup's console:

// Test basic service worker communication
async function testServiceWorker() {
    try {
        console.log('Testing service worker communication...');
        
        // Test POPUP_TEST message
        const response = await new Promise((resolve, reject) => {
            chrome.runtime.sendMessage({
                type: 'POPUP_TEST',
                data: { test: true, timestamp: Date.now() }
            }, (response) => {
                if (chrome.runtime.lastError) {
                    reject(new Error(chrome.runtime.lastError.message));
                } else {
                    resolve(response);
                }
            });
        });
        
        console.log('‚úÖ Service worker responded:', response);
        
        // Test SETTINGS_UPDATED message
        const settingsResponse = await new Promise((resolve, reject) => {
            chrome.runtime.sendMessage({
                type: 'SETTINGS_UPDATED',
                data: {
                    settings: {
                        reminderEnabled: true,
                        reminderInterval: 0.5,
                        notifications: true
                    }
                }
            }, (response) => {
                if (chrome.runtime.lastError) {
                    reject(new Error(chrome.runtime.lastError.message));
                } else {
                    resolve(response);
                }
            });
        });
        
        console.log('‚úÖ Settings update response:', settingsResponse);
        
    } catch (error) {
        console.error('‚ùå Service worker test failed:', error.message);
        
        if (error.message.includes('Could not establish connection')) {
            console.log('üîç Service worker is not running or not responding');
        }
    }
}

// Run the test
testServiceWorker();

// Check alarms
chrome.alarms.getAll().then(alarms => {
    console.log('Active alarms:', alarms);
});

// Check storage
chrome.storage.local.get(null).then(data => {
    console.log('Storage contents:', data);
});
            `;
            
            logObject(consoleCode, 'Console Test Code');
            
            // Also copy to clipboard if possible
            if (navigator.clipboard) {
                navigator.clipboard.writeText(consoleCode.trim()).then(() => {
                    log('‚úÖ Console code copied to clipboard!', 'success');
                }).catch(() => {
                    log('‚ö†Ô∏è Could not copy to clipboard, please copy manually', 'warning');
                });
            }
        }

        // Auto-run context check on load
        window.addEventListener('load', () => {
            log('üöÄ Starting service worker communication tests...', 'info');
            checkExtensionContext();
        });
    </script>
</body>
</html>