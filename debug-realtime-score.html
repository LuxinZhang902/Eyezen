<!DOCTYPE html>
<html>
<head>
    <title>Debug Real-time Score - EyeZen Extension</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .metric-display {
            display: inline-block;
            background: #e9ecef;
            padding: 8px 12px;
            margin: 5px;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîç EyeZen Real-time Score Debug Tool</h1>
    
    <div class="debug-section">
        <h2>üìä Current Status</h2>
        <div id="status" class="status info">Initializing debug tool...</div>
        <div id="metrics-display"></div>
    </div>
    
    <div class="debug-section">
        <h2>üéÆ Controls</h2>
        <button onclick="checkExtensionStatus()">Check Extension Status</button>
        <button onclick="testMessageFlow()">Test Message Flow</button>
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="simulateMetrics()">Simulate Eye Metrics</button>
    </div>
    
    <div class="debug-section">
        <h2>üìù Debug Logs</h2>
        <div id="logs"></div>
    </div>
    
    <div class="debug-section">
        <h2>üîß Troubleshooting Steps</h2>
        <ol>
            <li><strong>Check Extension Installation:</strong> Make sure EyeZen extension is installed and enabled</li>
            <li><strong>Camera Permission:</strong> Ensure camera permission is granted to the extension</li>
            <li><strong>Console Logs:</strong> Open Chrome DevTools (F12) and check for errors in Console tab</li>
            <li><strong>Background Script:</strong> Check if background service worker is running</li>
            <li><strong>Message Flow:</strong> Verify messages are flowing from CV worker ‚Üí Offscreen ‚Üí Popup</li>
            <li><strong>Real-time Processing:</strong> Confirm frame processing is running at ~15 FPS</li>
        </ol>
    </div>
    
    <div class="debug-section">
        <h2>üìã Expected Behavior</h2>
        <ul>
            <li>Real-time score should update every few seconds when face is detected</li>
            <li>Score range: 0-100 (higher = better eye health)</li>
            <li>Console should show "üëÅÔ∏è Eye metrics received" messages</li>
            <li>Popup should display live score in blue badge (upper left)</li>
            <li>Score calculation: 100 - (fatigueIndex * 100)</li>
        </ul>
    </div>
    
    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `status ${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logsDiv.appendChild(logEntry);
            logCount++;
            
            // Keep only last 20 logs
            if (logCount > 20) {
                logsDiv.removeChild(logsDiv.firstChild);
                logCount--;
            }
            
            // Auto-scroll to bottom
            logEntry.scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        function updateMetrics(metrics) {
            const metricsDiv = document.getElementById('metrics-display');
            if (metrics) {
                metricsDiv.innerHTML = `
                    <div class="metric-display">Fatigue: ${(metrics.fatigueIndex || 0).toFixed(3)}</div>
                    <div class="metric-display">Blink Rate: ${metrics.blinkRate || 0}</div>
                    <div class="metric-display">Score: ${Math.round(100 - (metrics.fatigueIndex * 100))}</div>
                    <div class="metric-display">EAR: ${(metrics.earValue || 0).toFixed(3)}</div>
                    <div class="metric-display">PERCLOS: ${(metrics.perclosValue || 0).toFixed(3)}</div>
                `;
            } else {
                metricsDiv.innerHTML = '<div class="metric-display">No metrics available</div>';
            }
        }
        
        function checkExtensionStatus() {
            log('Checking extension status...', 'info');
            
            if (typeof chrome === 'undefined' || !chrome.runtime) {
                log('‚ùå Chrome extension APIs not available', 'error');
                updateStatus('Extension APIs not available', 'error');
                return;
            }
            
            chrome.runtime.sendMessage({ type: 'PING' }, (response) => {
                if (chrome.runtime.lastError) {
                    log(`‚ùå Extension communication error: ${chrome.runtime.lastError.message}`, 'error');
                    updateStatus('Extension not responding', 'error');
                } else {
                    log('‚úÖ Extension is responding', 'success');
                    updateStatus('Extension is active', 'success');
                }
            });
        }
        
        function testMessageFlow() {
            log('Testing message flow...', 'info');
            
            // Listen for EYE_METRICS messages
            const messageListener = (message, sender, sendResponse) => {
                if (message.type === 'EYE_METRICS') {
                    log(`üìä Received eye metrics: fatigueIndex=${message.data.fatigueIndex}, blinkRate=${message.data.blinkRate}`, 'success');
                    updateMetrics(message.data);
                    updateStatus('Receiving real-time metrics', 'success');
                }
            };
            
            chrome.runtime.onMessage.addListener(messageListener);
            
            // Remove listener after 30 seconds
            setTimeout(() => {
                chrome.runtime.onMessage.removeListener(messageListener);
                log('Message listener removed after 30 seconds', 'info');
            }, 30000);
            
            log('üëÇ Listening for EYE_METRICS messages for 30 seconds...', 'info');
        }
        
        function simulateMetrics() {
            log('Simulating eye metrics...', 'warning');
            
            const simulatedMetrics = {
                fatigueIndex: Math.random() * 0.8,
                blinkRate: Math.floor(Math.random() * 20) + 5,
                earValue: 0.2 + Math.random() * 0.1,
                perclosValue: Math.random() * 0.3,
                posture: 'good'
            };
            
            updateMetrics(simulatedMetrics);
            log(`üé≠ Simulated metrics: ${JSON.stringify(simulatedMetrics)}`, 'warning');
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            logCount = 0;
            log('Logs cleared', 'info');
        }
        
        // Initialize
        window.addEventListener('load', () => {
            log('Debug tool loaded', 'info');
            checkExtensionStatus();
        });
        
        // Auto-check status every 10 seconds
        setInterval(() => {
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({ type: 'GET_CAMERA_STATE' }, (response) => {
                    if (!chrome.runtime.lastError && response) {
                        const status = response.isActive ? 'Camera active' : 'Camera inactive';
                        updateStatus(status, response.isActive ? 'success' : 'warning');
                    }
                });
            }
        }, 10000);
    </script>
</body>
</html>