(()=>{"use strict";var e,r,t,a={455:(e,r,t)=>{var a=t(848),o=t(338),n=t(540),s=t(235),i=t(123);class l{constructor(){this.session=null,this.isInitialized=!1}async initialize(){if(!("LanguageModel"in window))throw console.warn("Chrome AI Prompt API not available"),new Error('Chrome AI is not available. Please ensure you are using Chrome 127+ with the following flags enabled:\n\n1. chrome://flags/#optimization-guide-on-device-model → "Enabled BypassPerfRequirement"\n2. chrome://flags/#prompt-api-for-gemini-nano → "Enabled"\n\nThen restart Chrome completely.');const e=await window.LanguageModel.availability();if(console.log("Chrome AI model availability:",e),"no"===e)throw console.warn("Chrome AI model not available on this device"),new Error("Chrome AI is not available on this device. This may be due to:\n\n• Hardware requirements not met (need 22GB+ free space, 4GB+ VRAM)\n• Operating system not supported (requires macOS 13+ or Windows 10+)\n• Chrome flags not properly enabled\n\nPlease check the requirements and try again.");if("after-download"===e)console.log("Chrome AI model needs to be downloaded. Starting download..."),this.session=await window.languageModel.create({topK:3,temperature:.3,monitor(e){e.addEventListener("downloadprogress",e=>{const r=Math.round(100*e.loaded);console.log(`Chrome AI model download progress: ${r}%`)})}});else{if("available"!==e)throw console.warn("Unknown Chrome AI availability status:",e),new Error(`Chrome AI availability status is unknown: ${e}`);this.session=await window.LanguageModel.create({topK:3,temperature:.3})}this.isInitialized=!0,console.log("Chrome AI service initialized successfully")}async generateHealthSuggestion(e,r,t){this.isInitialized||await this.initialize();try{const a=this.buildHealthPrompt(e,r,t);console.log("Sending prompt to Chrome AI:",a);const o=await this.session.prompt(a);return console.log("Chrome AI response:",o),this.parseAIResponse(o,e,r,t)}catch(e){console.error("Chrome AI suggestion generation failed:",e);const r=e instanceof Error?e.message:"Unknown error occurred";throw new Error(`Chrome AI failed to generate suggestion: ${r}`)}}buildHealthPrompt(e,r,t){return`As an eye health expert, provide a brief personalized tip (max 40 words) based on these metrics:\n\nEye Health Score: ${e}/100\nFatigue Level: ${r}/100\nBlink Rate: ${t.blinkRate} blinks/min (normal: 15-20)\nEye Strain Index: ${(100*t.fatigueIndex).toFixed(1)}%\nPosture Status: ${t.posture}\n\nProvide a unique suggestion that is NOT a break activity. Focus on:\n- Environment adjustments (lighting, screen distance, humidity)\n- Workspace ergonomics (monitor height, chair position)\n- Daily habits (hydration, nutrition, sleep)\n- Posture improvements\n\nProvide:\n1. One specific actionable tip\n2. Urgency level (low/medium/high)\n3. Category (environment/posture/habits/nutrition/workspace)\n\nFormat: "[Tip] | [Urgency] | [Category]"`}parseAIResponse(e,r,t,a){try{const r=e.split("|").map(e=>e.trim());if(r.length>=3){const e=r[0];return{message:e,severity:this.normalizeSeverity(r[1]),category:this.normalizeCategory(r[2]),confidence:.85}}}catch(e){console.warn("Failed to parse AI response:",e)}return{message:e.substring(0,100),severity:this.determineSeverity(r,t),category:this.determineCategory(t,a),confidence:.7}}normalizeSeverity(e){const r=e.toLowerCase();return r.includes("high")||r.includes("urgent")||r.includes("critical")?"high":r.includes("medium")||r.includes("moderate")?"medium":"low"}normalizeCategory(e){const r=e.toLowerCase();return r.includes("environment")||r.includes("lighting")||r.includes("humidity")?"environment":r.includes("posture")||r.includes("position")?"posture":r.includes("habits")||r.includes("sleep")||r.includes("routine")?"habits":r.includes("nutrition")||r.includes("hydration")||r.includes("food")?"nutrition":r.includes("workspace")||r.includes("ergonomic")||r.includes("monitor")?"workspace":"environment"}determineSeverity(e,r){return r>70||e<30?"high":r>40||e<60?"medium":"low"}determineCategory(e,r){return r.posture===s.PostureStatus.FORWARD||r.posture===s.PostureStatus.TILTED?"posture":e>60?"habits":r.blinkRate<10?"environment":r.fatigueIndex>.5?"workspace":"environment"}getFallbackSuggestion(e,r,t){const a=this.determineSeverity(e,r),o=this.determineCategory(r,t);return{message:{environment:"Adjust your screen brightness to match room lighting and increase humidity.",posture:"Position your monitor 20-26 inches away and top of screen at eye level.",habits:"Stay hydrated with 8 glasses of water daily and get 7-8 hours of sleep.",nutrition:"Include omega-3 rich foods and leafy greens in your diet for eye health.",workspace:"Use proper lighting behind your screen and consider blue light filters."}[o],severity:a,category:o,confidence:.6}}async destroy(){if(this.session){try{await this.session.destroy()}catch(e){console.warn("Error destroying Chrome AI session:",e)}this.session=null}this.isInitialized=!1}}new l;const c=(0,n.lazy)(()=>t.e(57).then(t.bind(t,57))),d=(0,n.lazy)(()=>t.e(277).then(t.bind(t,277))),m=(0,n.lazy)(()=>t.e(410).then(t.bind(t,410))),h=(0,n.lazy)(()=>t.e(826).then(t.bind(t,826))),u=(0,n.lazy)(()=>t.e(616).then(t.bind(t,616))),g=new l,p=()=>t.e(911).then(t.bind(t,911)).then(e=>e.EyeHealthScorer),y=({onStartBreak:e,onOpenSettings:r})=>{const t=(0,n.useRef)(0),[o,l]=(0,n.useState)({status:s.UserStatus.GOOD,eyeScore:{current:50,daily:50,weekly:50,trend:"stable"},realtimeScore:-1,isLoading:!0,cameraEnabled:!1,lastBreakTime:null,streakDays:0,showCameraPermissionPopup:!1,isFeatureRestricted:!1,aiRecommendation:"Analyzing your eye health patterns...",aiCategory:"environment",aiLoading:!0,showLoginModal:!1,isLoggedIn:!1,userEmail:"",isModalOpen:!1,selectedBreakType:null,showReminderModal:!1,reminderInterval:30,isReminderActive:!1,showColorAdjustModal:!1});(0,n.useEffect)(()=>{console.log("🔥 POPUP: useEffect triggered, calling loadUserData"),w(),y();const e=setInterval(()=>{o.cameraEnabled&&w()},3e4),r=setInterval(S,5e3),t=setInterval(()=>{o.cameraEnabled&&j()},1e4),a=(e,r,t)=>{console.log("🔥 POPUP: Message received:",e.type,e),"EYE_METRICS"===e.type&&(console.log("🔥 POPUP: EYE_METRICS message received, calling handleEyeMetrics"),x(e.data))};if("undefined"!=typeof chrome&&chrome.runtime){chrome.runtime.onMessage.addListener(a),setTimeout(()=>{console.log("🧪 POPUP: Sending test message to service worker"),chrome.runtime.sendMessage({type:"POPUP_TEST",data:"Hello from popup"},e=>{chrome.runtime.lastError?console.log("🧪 POPUP: Test message failed (service worker may not be ready):",chrome.runtime.lastError.message):console.log("🧪 POPUP: Test message response:",e)})},1e3);const e=setInterval(async()=>{try{const e=await chrome.storage.local.get(["latest_eye_metrics"]);if(e.latest_eye_metrics){const{data:r,timestamp:t}=e.latest_eye_metrics;Date.now()-t<5e3&&(console.log("🔄 POPUP: Processing eye metrics from storage fallback:",r),x(r),await chrome.storage.local.remove(["latest_eye_metrics"]))}}catch(e){console.log("🔄 POPUP: Error polling storage for metrics:",e)}},1e3);window.storagePollingInterval=e}const n=(e,r)=>{"local"===r&&e.eyezen_login_state&&(console.log("Popup: Login state changed in storage:",e.eyezen_login_state),y())};return"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.addListener(n),()=>{clearInterval(e),clearInterval(r),clearInterval(t),window.storagePollingInterval&&clearInterval(window.storagePollingInterval),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage.removeListener(a),"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.removeListener(n)}},[]);const y=async()=>{try{if("undefined"!=typeof chrome&&chrome.storage){const e=(await chrome.storage.local.get(["eyezen_login_state"])).eyezen_login_state;e&&e.isLoggedIn&&l(r=>({...r,isLoggedIn:!0,userEmail:e.userEmail}))}}catch(e){console.error("Failed to load login state:",e)}},w=async()=>{console.log("🔥 POPUP: loadUserData function called");try{let e=await i.ChromeStorageService.getUserData();if(e||(await i.ChromeStorageService.initialize(),e=await i.ChromeStorageService.getUserData()),e){const r=e.metrics.slice(-10);console.log("🔍 POPUP: Recent metrics for health score calculation:",r.length,r);const t=(await p()).calculateScore(r);console.log("🔍 POPUP: Calculated health score:",t);const a=f(t.overall,r),o=b(e.breaks),n=e.breaks.filter(e=>e.completed).sort((e,r)=>r.endTime-e.endTime)[0],s=r.reduce((e,r)=>e+(r.fatigueIndex||0),0)/r.length;let i="environment",c="Analyzing your eye health patterns...";s>.7?(i="workspace",c="Consider optimizing your workspace setup for better eye health."):s>.4&&(i="posture",c="Focus on maintaining proper posture and screen distance.");const d=r[r.length-1],m=d?Math.round(Math.max(0,Math.min(100,100-100*d.fatigueIndex))):-1;window.eyeZenCameraStream=null,console.log("🔍 POPUP: Setting eyeScore.current to:",t.overall),l(r=>({...r,status:a,eyeScore:{current:t.overall,daily:t.overall,weekly:t.overall,trend:t.trend},realtimeScore:m,isLoading:!1,cameraEnabled:e.settings.cameraEnabled,lastBreakTime:n?.endTime||null,streakDays:o,showCameraPermissionPopup:!1,isFeatureRestricted:e.settings.metricsOnly,aiRecommendation:c,aiCategory:i,aiLoading:!1,showLoginModal:!1}))}}catch(e){console.error("🔥 POPUP: Failed to load user data:",e),console.error("🔥 POPUP: Error stack:",e instanceof Error?e.stack:"No stack trace"),l(e=>({...e,isLoading:!1}))}},x=async e=>{try{const r=(new Date).toISOString();console.log(`🔥 [${r}] POPUP: handleEyeMetrics called with:`,e),Date.now()-t.current>1e4&&(console.log("👤 Face detected! Received eye metrics:",e),console.log("📊 Real-time fatigue index:",e.fatigueIndex,"Blink rate:",e.blinkRate),t.current=Date.now());const a={timestamp:Date.now(),blinkRate:e.blinkRate||0,fatigueIndex:e.fatigueIndex||0,posture:e.posture||"unknown",earValue:e.earLeft||e.earRight||0,perclosValue:e.perclos||0};await i.ChromeStorageService.addMetrics(a);const o=[a],n=(await p()).calculateScore(o),s=n.overall,c=Math.max(0,Math.min(100,100-100*e.fatigueIndex)),d=f(s,[e]);console.log(`🔥 [${r}] POPUP: Score calculation:`),console.log(`  - fatigueIndex: ${e.fatigueIndex}`),console.log(`  - Eye Health Score: ${s}`),console.log(`  - realtimeFatigueScore: ${c}`),console.log("  - Health Score Details:",n),console.log(`  - rounded Eye Health score: ${Math.round(s)}`),l(e=>({...e,status:d,eyeScore:{...e.eyeScore,current:Math.round(s)},realtimeScore:Math.round(c)})),console.log(`🔥 [${r}] POPUP: Updated realtimeScore:`,Math.round(c))}catch(e){console.error("Error handling eye metrics:",e)}},f=(e,r)=>e>=80?s.UserStatus.GOOD:e>=60?s.UserStatus.TIRED:s.UserStatus.CRITICAL,b=e=>{const r=new Date;let t=0;for(let a=0;a<30;a++){const o=new Date(r);o.setDate(o.getDate()-a),o.setHours(0,0,0,0);const n=new Date(o);if(n.setHours(23,59,59,999),!(e.filter(e=>{const r=new Date(e.startTime);return r>=o&&r<=n&&e.completed}).length>=3)){if(0===a)break;break}t++}return t},v=e=>e>=80?"text-green-600":e>=60?"text-yellow-600":"text-red-600",C=e=>{l(r=>({...r,selectedBreakType:e,isModalOpen:!0}))},S=async()=>{try{const e=await navigator.permissions.query({name:"camera"}),r=window.eyeZenCameraStream;"denied"===e.state&&r&&(console.log("Camera permission revoked, updating extension state"),window.eyeZenCameraStream=null,await i.ChromeStorageService.updateSettings({cameraEnabled:!1}),l(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,realtimeScore:0})),chrome.runtime.sendMessage({type:"STOP_CAMERA"},e=>{chrome.runtime.lastError?console.error("❌ Error stopping camera due to permission revocation:",chrome.runtime.lastError.message):e?.success&&console.log("Camera stopped due to permission revocation")}))}catch(e){console.log("Could not check camera permission status:",e)}},j=async()=>{try{if(!o.cameraEnabled)return;chrome.runtime.sendMessage({type:"GET_CAMERA_STATE"},e=>{if(chrome.runtime.lastError)o.cameraEnabled&&console.error("❌ Error validating camera state:",chrome.runtime.lastError.message);else if(e&&void 0!==e.isActive){const r=e.isActive;o.cameraEnabled!==r&&(window.eyeZenCameraStream=!!r||null,l(e=>({...e,cameraEnabled:r})),i.ChromeStorageService.updateSettings({cameraEnabled:r}))}})}catch(e){o.cameraEnabled&&console.log("Could not validate camera state:",e)}};return(0,n.useEffect)(()=>{(async()=>{try{const e=await chrome.storage.local.get(["eyezen_reminder"]);e.eyezen_reminder&&e.eyezen_reminder.isActive&&l(r=>({...r,isReminderActive:!0,reminderInterval:e.eyezen_reminder.interval}))}catch(e){console.error("Failed to load reminder state:",e)}})()},[]),o.isLoading?(0,a.jsx)("div",{className:"w-[380px] h-[550px] bg-white flex items-center justify-center",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Loading EyeZen..."})]})}):(0,a.jsxs)(a.Fragment,{children:[o.showCameraPermissionPopup&&(0,a.jsx)(n.Suspense,{fallback:(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,a.jsx)(c,{isVisible:o.showCameraPermissionPopup,onApprove:async()=>{try{await i.ChromeStorageService.updateSettings({cameraEnabled:!0,metricsOnly:!1}),window.eyeZenCameraStream=!0,l(e=>({...e,cameraEnabled:!0,showCameraPermissionPopup:!1,isFeatureRestricted:!1}))}catch(e){console.error("Failed to approve camera access:",e)}},onReject:async()=>{try{await i.ChromeStorageService.updateSettings({cameraEnabled:!1,metricsOnly:!0}),window.eyeZenCameraStream=null,l(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,isFeatureRestricted:!0}))}catch(e){console.error("Failed to reject camera access:",e)}},onClose:()=>l(e=>({...e,showCameraPermissionPopup:!1}))})}),(0,a.jsx)(n.Suspense,{fallback:(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,a.jsx)(d,{isVisible:o.showLoginModal,onClose:()=>l(e=>({...e,showLoginModal:!1})),onLogin:async(e,r)=>{console.log("Login attempt:",{email:e});try{await new Promise(e=>setTimeout(e,1e3));const t=(await chrome.storage.local.get(["eyezen_users"])).eyezen_users||{};if(!t[e])throw new Error("No account found with this email address. Please sign up first.");if(t[e].password!==r)throw new Error("Incorrect password. Please try again.");l(r=>({...r,isLoggedIn:!0,userEmail:e,showLoginModal:!1})),await chrome.storage.local.set({eyezen_login_state:{isLoggedIn:!0,userEmail:e,loginTime:Date.now()}})}catch(e){throw e}},onSignup:async(e,r,t)=>{console.log("Signup attempt:",{email:e,name:t});try{await new Promise(e=>setTimeout(e,1e3));const a=(await chrome.storage.local.get(["eyezen_users"])).eyezen_users||{};if(a[e])throw new Error("An account with this email already exists. Please login instead.");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))throw new Error("Please enter a valid email address.");if(r.length<6)throw new Error("Password must be at least 6 characters long.");const o={email:e,password:r,name:t,createdAt:Date.now(),verified:!0};a[e]=o,await chrome.storage.local.set({eyezen_users:a}),l(r=>({...r,isLoggedIn:!0,userEmail:e,showLoginModal:!1})),await chrome.storage.local.set({eyezen_login_state:{isLoggedIn:!0,userEmail:e,loginTime:Date.now()}}),console.log("Signup successful")}catch(e){throw console.error("Signup failed:",e),e}}})}),(0,a.jsxs)("div",{className:"w-[380px] h-[650px] bg-white flex flex-col relative",children:[(0,a.jsxs)("div",{className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white p-4",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"text-2xl",children:"👁️"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-lg font-bold",children:"EyeZen"}),(0,a.jsx)("p",{className:"text-blue-100 text-xs opacity-90",children:"Eye Health Monitor"})]})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsxs)("button",{onClick:()=>l(e=>({...e,showReminderModal:!0})),className:"p-2 hover:bg-white/20 rounded-lg transition-colors "+(o.isReminderActive?"bg-yellow-500/30 text-yellow-200":""),title:o.isReminderActive?"Break reminder active":"Set break reminder",children:[(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),o.isReminderActive&&(0,a.jsx)("div",{className:"absolute -top-1 -right-1 w-2 h-2 bg-yellow-400 rounded-full"})]}),(0,a.jsx)("button",{onClick:()=>l(e=>({...e,showColorAdjustModal:!0})),className:"p-2 hover:bg-white/20 rounded-lg transition-colors",title:"Adjust Screen Color",children:(0,a.jsxs)("svg",{className:"w-4 h-4",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",children:[(0,a.jsx)("circle",{cx:"12",cy:"12",r:"9",strokeWidth:"2"}),(0,a.jsx)("path",{d:"M7 12h10",strokeWidth:"2"}),(0,a.jsx)("path",{d:"M12 7v10",strokeWidth:"2"})]})}),o.isLoggedIn?(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("span",{className:"text-xs text-blue-100 opacity-90 truncate max-w-20",children:o.userEmail.split("@")[0]}),(0,a.jsx)("button",{onClick:async()=>{await chrome.storage.local.remove(["eyezen_login_state"]),l(e=>({...e,isLoggedIn:!1,userEmail:""}))},className:"p-1 hover:bg-white/20 rounded transition-colors",title:"Logout",children:(0,a.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})})})]}):(0,a.jsx)("button",{onClick:()=>l(e=>({...e,showLoginModal:!0})),className:"p-2 hover:bg-white/20 rounded-lg transition-colors",title:"Login",children:(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})})]})]}),(0,a.jsx)("div",{className:"bg-white/10 backdrop-blur-sm rounded-lg p-3 border border-white/20",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,a.jsx)("div",{className:"text-lg",children:"📹"}),(0,a.jsxs)("div",{className:"flex-1",children:[(0,a.jsx)("div",{className:"font-semibold text-sm",children:"Camera Monitoring"}),(0,a.jsx)("div",{className:"text-xs text-blue-100 opacity-90",children:o.cameraEnabled?"Active - Tracking eye health":"Inactive - Click to enable"}),!o.cameraEnabled&&(0,a.jsx)("button",{onClick:()=>l(e=>({...e,showCameraPermissionPopup:!0})),className:"text-xs text-blue-200 hover:text-white underline mt-1 transition-colors",children:"Need help? View setup guide"}),o.cameraEnabled&&(0,a.jsxs)("button",{onClick:async()=>{try{if(!o.cameraEnabled)return void alert("Camera must be enabled to capture frames");const e=await new Promise((e,r)=>{chrome.runtime.sendMessage({type:"DOWNLOAD_FRAME"},t=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):t?e(t):r(new Error("No response received from offscreen document"))})});e.success?(console.log("📸 Frame downloaded successfully:",e.filename),alert(`Frame saved as: ${e.filename}`)):(console.error("❌ Failed to download frame:",e.error),alert(`Failed to download frame: ${e.error}`))}catch(e){console.error("Failed to download frame:",e),alert("Failed to download frame. Please try again.")}},className:"text-xs text-blue-200 hover:text-white underline mt-1 transition-colors flex items-center space-x-1",children:[(0,a.jsx)("span",{children:"📸"}),(0,a.jsx)("span",{children:"Download Current Frame"})]})]})]}),(0,a.jsx)("button",{onClick:async()=>{try{o.cameraEnabled?await(async()=>{try{chrome.runtime.sendMessage({type:"STOP_CAMERA"},e=>{chrome.runtime.lastError?console.error("❌ Error stopping camera:",chrome.runtime.lastError.message):e?.success&&console.log("Camera stopped successfully")}),window.eyeZenCameraStream=null,await i.ChromeStorageService.updateSettings({cameraEnabled:!1}),l(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,realtimeScore:0})),console.log("Camera deactivated")}catch(e){console.error("Failed to stop camera:",e)}})():await(async()=>{try{if(!confirm("📹 Camera Permission Setup\n\n🔒 Your privacy is protected - no video is recorded or transmitted, and images are only used for one-time analysis.\nContinue? (Cancel for timer-only mode)"))return await i.ChromeStorageService.updateSettings({cameraEnabled:!1,metricsOnly:!0}),void l(e=>({...e,cameraEnabled:!1,isFeatureRestricted:!0}));(await chrome.runtime.getContexts({})).find(e=>"OFFSCREEN_DOCUMENT"===e.contextType)||await chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Camera access for eye health monitoring"});const e=await new Promise((e,r)=>{chrome.runtime.sendMessage({type:"REQUEST_CAMERA"},t=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):t?e(t):r(new Error("No response received from offscreen document"))})});if(e.success)await i.ChromeStorageService.updateSettings({cameraEnabled:!0,metricsOnly:!1}),window.eyeZenCameraStream=!0,l(e=>({...e,cameraEnabled:!0,showCameraPermissionPopup:!1,isFeatureRestricted:!1})),console.log("Camera activated successfully"),alert(" Success! Camera is now active and AI eye health monitoring is running.");else{console.warn("Camera access denied:",e.error),await i.ChromeStorageService.updateSettings({cameraEnabled:!1,metricsOnly:!0}),window.eyeZenCameraStream=null,l(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,isFeatureRestricted:!0}));const r=`${e.error||"Camera access was denied."}\n\n🔧 **Why "Ask" doesn't work:**\nChrome extension popups close when permission dialogs appear, preventing you from clicking "Allow".\n\n**Solution - Set to "Always Allow":**\n\n**Method 1 - Chrome Address Bar:**\n1. Look for the camera icon (🎥) in Chrome's address bar\n2. Click it and select "Always allow"\n3. Refresh this extension\n\n**Method 2 - Chrome Settings:**\n1. Chrome Settings → Privacy and Security → Site Settings\n2. Click "Camera" → find this extension\n3. Change from "Ask" to "Allow"\n4. Refresh this extension\n\n✅ You can still use basic timer reminders without camera access.`;alert(r)}}catch(e){console.error("Failed to request camera access:",e),alert("Failed to request camera access. Please try again.")}})()}catch(e){console.error("Failed to toggle camera:",e)}},className:"relative inline-flex h-6 w-11 items-center rounded-full transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-white/50 "+(o.cameraEnabled?"bg-green-500 shadow-lg":"bg-white/30"),children:(0,a.jsx)("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 shadow-md "+(o.cameraEnabled?"translate-x-6":"translate-x-1")})})]})})]}),(0,a.jsx)("div",{className:"p-3 relative",children:(0,a.jsx)("div",{className:"text-center mb-3",children:(0,a.jsxs)("div",{className:"bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-3 mx-1 mb-2 border border-gray-100 shadow-sm",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("span",{className:"text-lg mr-2",children:o.eyeScore.current>=80?"😊":o.eyeScore.current>=60?"😐":o.eyeScore.current>=40?"😟":"😵"}),(0,a.jsx)("h2",{className:"text-sm font-semibold text-gray-800",children:"Eye Health Score"})]}),(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("span",{className:`text-xl font-bold ${v(o.eyeScore.current)}`,children:o.eyeScore.current}),(0,a.jsx)("span",{className:"text-sm text-gray-500 ml-1",children:"/100"}),o.cameraEnabled&&50===o.eyeScore.current&&(0,a.jsxs)("span",{className:"ml-2 text-xs text-blue-600 font-medium flex items-center",children:[(0,a.jsx)("span",{className:"animate-spin mr-1",children:"🔄"}),"Analyzing..."]})]})]}),(0,a.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-1.5 mb-2",children:(0,a.jsx)("div",{className:"h-1.5 rounded-full transition-all duration-500 "+(v(o.eyeScore.current).includes("green")?"bg-green-500":v(o.eyeScore.current).includes("yellow")?"bg-yellow-500":"bg-red-500"),style:{width:`${o.eyeScore.current}%`}})}),(0,a.jsx)("div",{className:"text-xs text-gray-500 text-center mb-2",children:"Based on eye strain, posture, fatigue levels"}),(0,a.jsx)("div",{className:"mt-3",children:(0,a.jsx)("button",{onClick:async()=>{try{l(e=>({...e,aiLoading:!0}));const e=o.eyeScore.current||50,r=o.realtimeScore||50,t={blinkRate:15,fatigueIndex:r/100,posture:"good",earValue:.25,perclosValue:.2,timestamp:Date.now()},a=await g.generateHealthSuggestion(e,r,t);l(e=>({...e,aiRecommendation:a.message,aiCategory:a.category,aiLoading:!1})),alert(`AI Health Suggestion (${a.category}):\n\n${a.message}`)}catch(e){console.error("Failed to generate AI recommendation:",e),l(e=>({...e,aiLoading:!1}));const r=e instanceof Error?e.message:"Unknown error occurred";alert(`Chrome AI Error: ${r}`)}},disabled:o.aiLoading,className:"w-full px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-400 hover:to-emerald-400 transition-all duration-200 font-medium flex items-center justify-center space-x-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:o.aiLoading?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"}),(0,a.jsx)("span",{children:"Getting AI Suggestions..."})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{children:"🤖"}),(0,a.jsx)("span",{children:"Get AI Health Suggestions"})]})})})]})})}),(0,a.jsxs)("div",{className:"px-4 pb-4 flex-1 overflow-y-auto",children:[(0,a.jsxs)("div",{className:"mb-2",children:[(0,a.jsx)("h3",{className:"text-xs font-medium text-gray-600 mb-1",children:"Choose Your Break"}),(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-1",children:[(0,a.jsxs)("button",{onClick:()=>C(s.BreakType.MICRO),className:"flex flex-col items-center p-2 bg-gradient-to-br from-yellow-300 to-orange-400 hover:from-yellow-400 hover:to-orange-500 rounded border border-orange-300 transition-all duration-200 hover:shadow-md text-white",children:[(0,a.jsx)("span",{className:"text-lg mb-1",children:"⚡"}),(0,a.jsx)("span",{className:"text-xs font-medium text-white",children:"Quick"}),(0,a.jsx)("span",{className:"text-xs text-white opacity-90",children:"20 sec"})]}),(0,a.jsxs)("button",{onClick:()=>C(s.BreakType.SHORT),className:"flex flex-col items-center p-2 bg-gradient-to-br from-green-400 to-emerald-500 hover:from-green-500 hover:to-emerald-600 rounded border border-emerald-400 transition-all duration-200 hover:shadow-md text-white",children:[(0,a.jsx)("span",{className:"text-lg mb-1",children:"👁️"}),(0,a.jsx)("span",{className:"text-xs font-medium text-white",children:"Eye Break"}),(0,a.jsx)("span",{className:"text-xs text-white opacity-90",children:"5 min"})]}),(0,a.jsxs)("button",{onClick:()=>C(s.BreakType.LONG),className:"flex flex-col items-center p-2 bg-gradient-to-br from-purple-400 to-indigo-500 hover:from-purple-500 hover:to-indigo-600 rounded border border-indigo-400 transition-all duration-200 hover:shadow-md text-white",children:[(0,a.jsx)("span",{className:"text-lg mb-1",children:"🧘"}),(0,a.jsx)("span",{className:"text-xs font-medium text-white",children:"Wellness"}),(0,a.jsx)("span",{className:"text-xs text-white opacity-90",children:"15 min"})]})]})]}),(0,a.jsxs)("button",{onClick:()=>{o.isLoggedIn?r():l(e=>({...e,showLoginModal:!0}))},className:"w-full mt-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors flex items-center justify-center space-x-2",children:[!o.isLoggedIn&&(0,a.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,a.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})}),(0,a.jsx)("span",{children:o.isLoggedIn?"View detailed dashboard →":"Login to view dashboard →"})]})]}),(0,a.jsx)(n.Suspense,{fallback:(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,a.jsx)(m,{isOpen:o.isModalOpen,breakType:o.selectedBreakType,onClose:()=>{l(e=>({...e,isModalOpen:!1,selectedBreakType:null}))},onStartBreak:e})}),(0,a.jsx)(n.Suspense,{fallback:(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,a.jsx)(h,{isVisible:o.showReminderModal,onClose:()=>l(e=>({...e,showReminderModal:!1})),onSetReminder:async e=>{try{await chrome.alarms.clear("eyezen_break_reminder"),await chrome.alarms.clear("break-reminder"),await chrome.alarms.create("break-reminder",{delayInMinutes:e,periodInMinutes:e}),console.log("Break reminder set for every",e,"minutes"),await i.ChromeStorageService.updateSettings({reminderInterval:e,reminderEnabled:!0}),console.log("Reminder settings saved to user data:",{reminderInterval:e,reminderEnabled:!0}),l(r=>({...r,isReminderActive:!0,reminderInterval:e,showReminderModal:!1})),console.log(`Break reminder set for every ${e} minutes`)}catch(e){console.error("Failed to set reminder:",e),alert("Failed to set reminder. Please try again.")}},onClearReminder:async()=>{try{await chrome.alarms.clear("eyezen_break_reminder"),await chrome.alarms.clear("break-reminder"),await chrome.storage.local.remove(["eyezen_reminder"]),l(e=>({...e,isReminderActive:!1,showReminderModal:!1})),console.log("Break reminder cleared")}catch(e){console.error("Failed to clear reminder:",e)}},isReminderActive:o.isReminderActive,currentInterval:o.reminderInterval})}),(0,a.jsx)(n.Suspense,{fallback:(0,a.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,a.jsx)(u,{isVisible:o.showColorAdjustModal,onClose:()=>l(e=>({...e,showColorAdjustModal:!1})),onApply:async e=>{try{await chrome.storage.local.set({eyezen_color_settings:e});const r=await chrome.tabs.query({active:!0,currentWindow:!0}),t=r&&r[0];t?.id&&chrome.scripting&&await chrome.scripting.executeScript({target:{tabId:t.id},func:e=>{const r="eyezen-color-overlay";let t=document.getElementById(r);t||(t=document.createElement("div"),t.id=r,t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100vw",t.style.height="100vh",t.style.pointerEvents="none",t.style.zIndex="2147483647",t.style.mixBlendMode="multiply",document.documentElement.appendChild(t));const{r:a,g:o,b:n}=(e=>{const r=e.replace("#","");return{r:parseInt(r.substring(0,2),16),g:parseInt(r.substring(2,4),16),b:parseInt(r.substring(4,6),16)}})(e.color||"#FFB74D");t.style.backgroundColor=`rgba(${a}, ${o}, ${n}, ${e.tintOpacity??.25})`;const s="number"==typeof e.brightness?e.brightness:1;document.documentElement.style.filter=`brightness(${s})`},args:[e]})}catch(e){}l(e=>({...e,showColorAdjustModal:!1}))}})})]})]})};document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("popup-root");if(e){e.innerHTML="";try{const r=(0,o.createRoot)(e),t=e=>{chrome.runtime.sendMessage({action:"START_BREAK",breakType:e},e=>{e?.success?window.close():console.error("Failed to start break:",e?.error)})},n=()=>{chrome.runtime.openOptionsPage(),window.close()};r.render((0,a.jsx)(y,{onStartBreak:t,onOpenSettings:n}))}catch(r){console.error("Failed to initialize popup React root:",r),e.innerHTML='\n      <div style="padding: 20px; text-align: center; color: red;">\n        <h3>Failed to load popup</h3>\n        <p>Please try reloading the extension.</p>\n      </div>\n    '}}else console.error("Popup root element not found")}),window.addEventListener("error",e=>{console.error("Popup error:",e.error)}),window.addEventListener("unhandledrejection",e=>{console.error("Popup unhandled promise rejection:",e.reason)})}},o={};function n(e){var r=o[e];if(void 0!==r)return r.exports;var t=o[e]={exports:{}};return a[e](t,t.exports,n),t.exports}n.m=a,e=[],n.O=(r,t,a,o)=>{if(!t){var s=1/0;for(d=0;d<e.length;d++){for(var[t,a,o]=e[d],i=!0,l=0;l<t.length;l++)(!1&o||s>=o)&&Object.keys(n.O).every(e=>n.O[e](t[l]))?t.splice(l--,1):(i=!1,o<s&&(s=o));if(i){e.splice(d--,1);var c=a();void 0!==c&&(r=c)}}return r}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[t,a,o]},n.d=(e,r)=>{for(var t in r)n.o(r,t)&&!n.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:r[t]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce((r,t)=>(n.f[t](e,r),r),[])),n.u=e=>e+".js",n.miniCssF=e=>{},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,r)=>Object.prototype.hasOwnProperty.call(e,r),r={},t="eyezen-chrome-extension:",n.l=(e,a,o,s)=>{if(r[e])r[e].push(a);else{var i,l;if(void 0!==o)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var m=c[d];if(m.getAttribute("src")==e||m.getAttribute("data-webpack")==t+o){i=m;break}}i||(l=!0,(i=document.createElement("script")).charset="utf-8",i.timeout=120,n.nc&&i.setAttribute("nonce",n.nc),i.setAttribute("data-webpack",t+o),i.src=e),r[e]=[a];var h=(t,a)=>{i.onerror=i.onload=null,clearTimeout(u);var o=r[e];if(delete r[e],i.parentNode&&i.parentNode.removeChild(i),o&&o.forEach(e=>e(a)),t)return t(a)},u=setTimeout(h.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=h.bind(null,i.onerror),i.onload=h.bind(null,i.onload),l&&document.head.appendChild(i)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var r=n.g.document;if(!e&&r&&(r.currentScript&&"SCRIPT"===r.currentScript.tagName.toUpperCase()&&(e=r.currentScript.src),!e)){var t=r.getElementsByTagName("script");if(t.length)for(var a=t.length-1;a>-1&&(!e||!/^http(s?):/.test(e));)e=t[a--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),(()=>{var e={887:0};n.f.j=(r,t)=>{var a=n.o(e,r)?e[r]:void 0;if(0!==a)if(a)t.push(a[2]);else{var o=new Promise((t,o)=>a=e[r]=[t,o]);t.push(a[2]=o);var s=n.p+n.u(r),i=new Error;n.l(s,t=>{if(n.o(e,r)&&(0!==(a=e[r])&&(e[r]=void 0),a)){var o=t&&("load"===t.type?"missing":t.type),s=t&&t.target&&t.target.src;i.message="Loading chunk "+r+" failed.\n("+o+": "+s+")",i.name="ChunkLoadError",i.type=o,i.request=s,a[1](i)}},"chunk-"+r,r)}},n.O.j=r=>0===e[r];var r=(r,t)=>{var a,o,[s,i,l]=t,c=0;if(s.some(r=>0!==e[r])){for(a in i)n.o(i,a)&&(n.m[a]=i[a]);if(l)var d=l(n)}for(r&&r(t);c<s.length;c++)o=s[c],n.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return n.O(d)},t=self.webpackChunkeyezen_chrome_extension=self.webpackChunkeyezen_chrome_extension||[];t.forEach(r.bind(null,0)),t.push=r.bind(null,t.push.bind(t))})();var s=n.O(void 0,[644,59],()=>n(455));s=n.O(s)})();