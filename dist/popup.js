/*! For license information please see popup.js.LICENSE.txt */
(()=>{"use strict";var e,t,r,n={455:(e,t,r)=>{var n=r(848),a=r(338),o=r(540),s=r(235),i=r(123);class l{constructor(){this.session=null,this.isInitialized=!1}async initialize(){try{if(!("LanguageModel"in window))return console.warn("Chrome AI Prompt API not available"),!1;const e=await window.LanguageModel.availability();if(console.log("Chrome AI model availability:",e),"no"===e)return console.warn("Chrome AI model not available on this device"),!1;if("downloadable"===e||"downloading"===e)console.log("Chrome AI model needs to be downloaded. Starting download..."),this.session=await window.LanguageModel.create({topK:3,temperature:.3,monitor(e){e.addEventListener("downloadprogress",e=>{const t=Math.round(100*e.loaded);console.log(`Chrome AI model download progress: ${t}%`)})}});else{if("readily"!==e)return console.warn("Unknown Chrome AI availability status:",e),!1;this.session=await window.LanguageModel.create({topK:3,temperature:.3})}return this.isInitialized=!0,console.log("Chrome AI service initialized successfully"),!0}catch(e){return console.error("Failed to initialize Chrome AI service:",e),!1}}async generateHealthSuggestion(e,t,r){if(!this.isInitialized&&!await this.initialize())return this.getFallbackSuggestion(e,t,r);try{const n=this.buildHealthPrompt(e,t,r),a=await this.session.prompt(n);return this.parseAIResponse(a,e,t,r)}catch(n){return console.error("Chrome AI suggestion generation failed:",n),this.getFallbackSuggestion(e,t,r)}}buildHealthPrompt(e,t,r){return`As an eye health expert, provide a brief personalized tip (max 40 words) based on these metrics:\n\nEye Health Score: ${e}/100\nFatigue Level: ${t}/100\nBlink Rate: ${r.blinkRate} blinks/min (normal: 15-20)\nEye Strain Index: ${(100*r.fatigueIndex).toFixed(1)}%\nPosture Status: ${r.posture}\n\nProvide a unique suggestion that is NOT a break activity. Focus on:\n- Environment adjustments (lighting, screen distance, humidity)\n- Workspace ergonomics (monitor height, chair position)\n- Daily habits (hydration, nutrition, sleep)\n- Posture improvements\n\nProvide:\n1. One specific actionable tip\n2. Urgency level (low/medium/high)\n3. Category (environment/posture/habits/nutrition/workspace)\n\nFormat: "[Tip] | [Urgency] | [Category]"`}parseAIResponse(e,t,r,n){try{const t=e.split("|").map(e=>e.trim());if(t.length>=3){const e=t[0];return{message:e,severity:this.normalizeSeverity(t[1]),category:this.normalizeCategory(t[2]),confidence:.85}}}catch(e){console.warn("Failed to parse AI response:",e)}return{message:e.substring(0,100),severity:this.determineSeverity(t,r),category:this.determineCategory(r,n),confidence:.7}}normalizeSeverity(e){const t=e.toLowerCase();return t.includes("high")||t.includes("urgent")||t.includes("critical")?"high":t.includes("medium")||t.includes("moderate")?"medium":"low"}normalizeCategory(e){const t=e.toLowerCase();return t.includes("environment")||t.includes("lighting")||t.includes("humidity")?"environment":t.includes("posture")||t.includes("position")?"posture":t.includes("habits")||t.includes("sleep")||t.includes("routine")?"habits":t.includes("nutrition")||t.includes("hydration")||t.includes("food")?"nutrition":t.includes("workspace")||t.includes("ergonomic")||t.includes("monitor")?"workspace":"environment"}determineSeverity(e,t){return t>70||e<30?"high":t>40||e<60?"medium":"low"}determineCategory(e,t){return t.posture===s.PostureStatus.FORWARD||t.posture===s.PostureStatus.TILTED?"posture":e>60?"habits":t.blinkRate<10?"environment":t.fatigueIndex>.5?"workspace":"environment"}getFallbackSuggestion(e,t,r){const n=this.determineSeverity(e,t),a=this.determineCategory(t,r);return{message:{environment:"Adjust your screen brightness to match room lighting and increase humidity.",posture:"Position your monitor 20-26 inches away and top of screen at eye level.",habits:"Stay hydrated with 8 glasses of water daily and get 7-8 hours of sleep.",nutrition:"Include omega-3 rich foods and leafy greens in your diet for eye health.",workspace:"Use proper lighting behind your screen and consider blue light filters."}[a],severity:n,category:a,confidence:.6}}async destroy(){if(this.session){try{await this.session.destroy()}catch(e){console.warn("Error destroying Chrome AI session:",e)}this.session=null}this.isInitialized=!1}}new l;const c=(0,o.lazy)(()=>r.e(57).then(r.bind(r,57))),d=(0,o.lazy)(()=>r.e(277).then(r.bind(r,277))),m=(0,o.lazy)(()=>r.e(410).then(r.bind(r,410))),u=new l,h=()=>r.e(911).then(r.bind(r,911)).then(e=>e.EyeHealthScorer),g=({onStartBreak:e,onOpenSettings:t})=>{const a=(0,o.useRef)(0),[l,g]=(0,o.useState)({status:s.UserStatus.GOOD,eyeScore:{current:50,daily:50,weekly:50,trend:"stable"},realtimeScore:-1,isLoading:!0,cameraEnabled:!0,lastBreakTime:null,streakDays:0,showCameraPermissionPopup:!1,isFeatureRestricted:!1,aiRecommendation:"Analyzing your eye health patterns...",aiCategory:"environment",aiLoading:!0,showLoginModal:!1,isLoggedIn:!1,userEmail:"",isModalOpen:!1,selectedBreakType:null});(0,o.useEffect)(()=>{console.log("🔥 POPUP: useEffect triggered, calling loadUserData"),f(),p();const e=setInterval(f,3e4),t=setInterval(S,5e3),r=setInterval(()=>{C()},3e3),n=(e,t,r)=>{console.log("🔥 POPUP: Message received:",e.type,e),"EYE_METRICS"===e.type&&(console.log("🔥 POPUP: EYE_METRICS message received, calling handleEyeMetrics"),y(e.data))};if("undefined"!=typeof chrome&&chrome.runtime){chrome.runtime.onMessage.addListener(n),setTimeout(()=>{console.log("🧪 POPUP: Sending test message to service worker"),chrome.runtime.sendMessage({type:"POPUP_TEST",data:"Hello from popup"},e=>{console.log("🧪 POPUP: Test message response:",e)})},1e3);const e=setInterval(async()=>{try{const e=await chrome.storage.local.get(["latest_eye_metrics"]);if(e.latest_eye_metrics){const{data:t,timestamp:r}=e.latest_eye_metrics;Date.now()-r<5e3&&(console.log("🔄 POPUP: Processing eye metrics from storage fallback:",t),y(t),await chrome.storage.local.remove(["latest_eye_metrics"]))}}catch(e){console.log("🔄 POPUP: Error polling storage for metrics:",e)}},1e3);window.storagePollingInterval=e}const a=(e,t)=>{"local"===t&&e.eyezen_login_state&&(console.log("Popup: Login state changed in storage:",e.eyezen_login_state),p())};return"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.addListener(a),()=>{clearInterval(e),clearInterval(t),clearInterval(r),window.storagePollingInterval&&clearInterval(window.storagePollingInterval),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage.removeListener(n),"undefined"!=typeof chrome&&chrome.storage&&chrome.storage.onChanged&&chrome.storage.onChanged.removeListener(a)}},[]);const p=async()=>{try{if("undefined"!=typeof chrome&&chrome.storage){const e=(await chrome.storage.local.get(["eyezen_login_state"])).eyezen_login_state;e&&e.isLoggedIn&&g(t=>({...t,isLoggedIn:!0,userEmail:e.userEmail}))}}catch(e){console.error("Failed to load login state:",e)}},f=async()=>{console.log("🔥 POPUP: loadUserData function called");try{let e=await i.ChromeStorageService.getUserData();if(e||(await i.ChromeStorageService.initialize(),e=await i.ChromeStorageService.getUserData()),e){const t=e.metrics.slice(-10);console.log("🔍 POPUP: Recent metrics for health score calculation:",t.length,t);const r=(await h()).calculateScore(t);console.log("🔍 POPUP: Calculated health score:",r);const n=w(r.overall,t),a=b(e.breaks),o=e.breaks.filter(e=>e.completed).sort((e,t)=>t.endTime-e.endTime)[0],s=t.reduce((e,t)=>e+(t.fatigueIndex||0),0)/t.length;let i="environment",l="Analyzing your eye health patterns...";s>.7?(i="workspace",l="Consider optimizing your workspace setup for better eye health."):s>.4&&(i="posture",l="Focus on maintaining proper posture and screen distance.");const c=t[t.length-1],d=c?Math.round(Math.max(0,Math.min(100,100-100*c.fatigueIndex))):-1;window.eyeZenCameraStream=null,console.log("🔍 POPUP: Setting eyeScore.current to:",r.overall),g(t=>({...t,status:n,eyeScore:{current:r.overall,daily:r.overall,weekly:r.overall,trend:r.trend},realtimeScore:d,isLoading:!1,cameraEnabled:e.settings.cameraEnabled,lastBreakTime:o?.endTime||null,streakDays:a,showCameraPermissionPopup:!1,isFeatureRestricted:e.settings.metricsOnly,aiRecommendation:l,aiCategory:i,aiLoading:!1,showLoginModal:!1}))}}catch(e){console.error("🔥 POPUP: Failed to load user data:",e),console.error("🔥 POPUP: Error stack:",e instanceof Error?e.stack:"No stack trace"),g(e=>({...e,isLoading:!1}))}},y=async e=>{try{const t=(new Date).toISOString();console.log(`🔥 [${t}] POPUP: handleEyeMetrics called with:`,e),Date.now()-a.current>1e4&&(console.log("👤 Face detected! Received eye metrics:",e),console.log("📊 Real-time fatigue index:",e.fatigueIndex,"Blink rate:",e.blinkRate),a.current=Date.now());const n={timestamp:Date.now(),blinkRate:e.blinkRate||0,fatigueIndex:e.fatigueIndex||0,posture:e.posture||"unknown",earValue:e.earLeft||e.earRight||0,perclosValue:e.perclos||0};await i.ChromeStorageService.addMetrics(n);const o=[n],s=(await h()).calculateScore(o),l=s.overall,c=Math.max(0,Math.min(100,100-100*e.fatigueIndex)),d=w(l,[e]);console.log(`🔥 [${t}] POPUP: Score calculation:`),console.log(`  - fatigueIndex: ${e.fatigueIndex}`),console.log(`  - Eye Health Score: ${l}`),console.log(`  - realtimeFatigueScore: ${c}`),console.log("  - Health Score Details:",s),console.log(`  - rounded Eye Health score: ${Math.round(l)}`);let m="Your eyes are healthy! Keep up the good work.",p="environment";g(e=>({...e,aiLoading:!0}));try{const t=await u.generateHealthSuggestion(l,c,e);if(m=t.message,p=t.category,console.log("🤖 Chrome AI Suggestion:",t),t.confidence<.7){const[e,t,a]=await Promise.all([r.e(764).then(r.bind(r,764)).then(e=>e.ChromeAIService),r.e(224).then(r.bind(r,224)).then(e=>e.AICoachService),r.e(552).then(r.bind(r,552)).then(e=>e.ChromeAIVisionService)]),o=window.eyeZenCameraStream;if(o&&o.getVideoTracks().length>0){const e=document.querySelector("video");if(e){const t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight;const r=t.getContext("2d");if(r){r.drawImage(e,0,0);const o=t.toDataURL("image/jpeg",.8),s=await a.analyzeEyeStrain(o,n);m=s.recommendations[0]||m,p=s.strainLevel>70?"workspace":s.strainLevel>40?"posture":"environment",console.log("🤖 Chrome AI Vision Analysis:",s)}}}}}catch(t){console.warn("Chrome AI analysis failed, using fallback:",t),e.fatigueIndex>.7?(m="Consider optimizing your workspace lighting and taking regular breaks.",p="workspace"):e.fatigueIndex>.4?(m="Focus on maintaining proper posture and screen distance.",p="posture"):e.blinkRate<10&&(m="Adjust screen brightness and humidity levels for comfort.",p="environment")}g(e=>({...e,status:d,eyeScore:{...e.eyeScore,current:Math.round(l)},realtimeScore:Math.round(c),aiRecommendation:m,aiCategory:p,aiLoading:!1})),console.log(`🔥 [${t}] POPUP: Updated realtimeScore:`,Math.round(c))}catch(e){console.error("Error handling eye metrics:",e)}},w=(e,t)=>e>=80?s.UserStatus.GOOD:e>=60?s.UserStatus.TIRED:s.UserStatus.CRITICAL,b=e=>{const t=new Date;let r=0;for(let n=0;n<30;n++){const a=new Date(t);a.setDate(a.getDate()-n),a.setHours(0,0,0,0);const o=new Date(a);if(o.setHours(23,59,59,999),!(e.filter(e=>{const t=new Date(e.startTime);return t>=a&&t<=o&&e.completed}).length>=3)){if(0===n)break;break}r++}return r},x=e=>e>=80?"text-green-600":e>=60?"text-yellow-600":"text-red-600",v=e=>{g(t=>({...t,selectedBreakType:e,isModalOpen:!0}))},S=async()=>{try{const e=await navigator.permissions.query({name:"camera"}),t=window.eyeZenCameraStream;"denied"===e.state&&t&&(console.log("Camera permission revoked, updating extension state"),window.eyeZenCameraStream=null,await i.ChromeStorageService.updateSettings({cameraEnabled:!1}),g(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,realtimeScore:0})),chrome.runtime.sendMessage({type:"STOP_CAMERA"},e=>{chrome.runtime.lastError?console.error("❌ Error stopping camera due to permission revocation:",chrome.runtime.lastError.message):e?.success&&console.log("Camera stopped due to permission revocation")}))}catch(e){console.log("Could not check camera permission status:",e)}},C=async()=>{try{chrome.runtime.sendMessage({type:"GET_CAMERA_STATE"},e=>{if(chrome.runtime.lastError)console.error("❌ Error validating camera state:",chrome.runtime.lastError.message);else if(e&&void 0!==e.isActive){const t=e.isActive;l.cameraEnabled!==t&&(window.eyeZenCameraStream=!!t||null,g(e=>({...e,cameraEnabled:t})),i.ChromeStorageService.updateSettings({cameraEnabled:t}))}})}catch(e){console.log("Could not validate camera state:",e)}};return l.isLoading?(0,n.jsx)("div",{className:"w-[380px] h-[550px] bg-white flex items-center justify-center",children:(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),(0,n.jsx)("p",{className:"text-gray-600",children:"Loading EyeZen..."})]})}):(0,n.jsxs)(n.Fragment,{children:[l.showCameraPermissionPopup&&(0,n.jsx)(o.Suspense,{fallback:(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,n.jsx)(c,{isVisible:l.showCameraPermissionPopup,onApprove:async()=>{try{await i.ChromeStorageService.updateSettings({cameraEnabled:!0,metricsOnly:!1}),window.eyeZenCameraStream=!0,g(e=>({...e,cameraEnabled:!0,showCameraPermissionPopup:!1,isFeatureRestricted:!1}))}catch(e){console.error("Failed to approve camera access:",e)}},onReject:async()=>{try{await i.ChromeStorageService.updateSettings({cameraEnabled:!1,metricsOnly:!0}),window.eyeZenCameraStream=null,g(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,isFeatureRestricted:!0}))}catch(e){console.error("Failed to reject camera access:",e)}},onClose:()=>g(e=>({...e,showCameraPermissionPopup:!1}))})}),(0,n.jsx)(o.Suspense,{fallback:(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,n.jsx)(d,{isVisible:l.showLoginModal,onClose:()=>g(e=>({...e,showLoginModal:!1})),onLogin:async(e,t)=>{console.log("Login attempt:",{email:e});try{await new Promise(e=>setTimeout(e,1e3));const r=(await chrome.storage.local.get(["eyezen_users"])).eyezen_users||{};if(!r[e])throw new Error("No account found with this email address. Please sign up first.");if(r[e].password!==t)throw new Error("Incorrect password. Please try again.");g(t=>({...t,isLoggedIn:!0,userEmail:e,showLoginModal:!1})),await chrome.storage.local.set({eyezen_login_state:{isLoggedIn:!0,userEmail:e,loginTime:Date.now()}})}catch(e){throw e}},onSignup:async(e,t,r)=>{console.log("Signup attempt:",{email:e,name:r});try{await new Promise(e=>setTimeout(e,1e3));const n=(await chrome.storage.local.get(["eyezen_users"])).eyezen_users||{};if(n[e])throw new Error("An account with this email already exists. Please login instead.");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))throw new Error("Please enter a valid email address.");if(t.length<6)throw new Error("Password must be at least 6 characters long.");const a={email:e,password:t,name:r,createdAt:Date.now(),verified:!0};n[e]=a,await chrome.storage.local.set({eyezen_users:n}),g(t=>({...t,isLoggedIn:!0,userEmail:e,showLoginModal:!1})),await chrome.storage.local.set({eyezen_login_state:{isLoggedIn:!0,userEmail:e,loginTime:Date.now()}})}catch(e){throw e}}})}),(0,n.jsxs)("div",{className:"w-[380px] h-[650px] bg-white flex flex-col relative",children:[(0,n.jsxs)("div",{className:"bg-gradient-to-r from-green-600 to-emerald-600 text-white p-4",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,n.jsx)("div",{className:"text-2xl",children:"👁️"}),(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{className:"text-lg font-bold",children:"EyeZen"}),(0,n.jsx)("p",{className:"text-blue-100 text-xs opacity-90",children:"Eye Health Monitor"})]})]}),l.isLoggedIn?(0,n.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,n.jsx)("span",{className:"text-xs text-blue-100 opacity-90 truncate max-w-20",children:l.userEmail.split("@")[0]}),(0,n.jsx)("button",{onClick:async()=>{await chrome.storage.local.remove(["eyezen_login_state"]),g(e=>({...e,isLoggedIn:!1,userEmail:""}))},className:"p-1 hover:bg-white/20 rounded transition-colors",title:"Logout",children:(0,n.jsx)("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"})})})]}):(0,n.jsx)("button",{onClick:()=>g(e=>({...e,showLoginModal:!0})),className:"p-2 hover:bg-white/20 rounded-lg transition-colors",title:"Login",children:(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})})})]}),(0,n.jsx)("div",{className:"bg-white/10 backdrop-blur-sm rounded-lg p-3 border border-white/20",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,n.jsx)("div",{className:"text-lg",children:"📹"}),(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsx)("div",{className:"font-semibold text-sm",children:"Camera Monitoring"}),(0,n.jsx)("div",{className:"text-xs text-blue-100 opacity-90",children:l.cameraEnabled?"Active - Tracking eye health":"Inactive - Click to enable"}),!l.cameraEnabled&&(0,n.jsx)("button",{onClick:()=>g(e=>({...e,showCameraPermissionPopup:!0})),className:"text-xs text-blue-200 hover:text-white underline mt-1 transition-colors",children:"Need help? View setup guide"}),l.cameraEnabled&&(0,n.jsxs)("button",{onClick:async()=>{try{if(!l.cameraEnabled)return void alert("Camera must be enabled to capture frames");const e=await new Promise((e,t)=>{chrome.runtime.sendMessage({type:"DOWNLOAD_FRAME"},r=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):r?e(r):t(new Error("No response received from offscreen document"))})});e.success?(console.log("📸 Frame downloaded successfully:",e.filename),alert(`Frame saved as: ${e.filename}`)):(console.error("❌ Failed to download frame:",e.error),alert(`Failed to download frame: ${e.error}`))}catch(e){console.error("Failed to download frame:",e),alert("Failed to download frame. Please try again.")}},className:"text-xs text-blue-200 hover:text-white underline mt-1 transition-colors flex items-center space-x-1",children:[(0,n.jsx)("span",{children:"📸"}),(0,n.jsx)("span",{children:"Download Current Frame"})]})]})]}),(0,n.jsx)("button",{onClick:async()=>{try{l.cameraEnabled?await(async()=>{try{chrome.runtime.sendMessage({type:"STOP_CAMERA"},e=>{chrome.runtime.lastError?console.error("❌ Error stopping camera:",chrome.runtime.lastError.message):e?.success&&console.log("Camera stopped successfully")}),window.eyeZenCameraStream=null,await i.ChromeStorageService.updateSettings({cameraEnabled:!1}),g(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,realtimeScore:0})),console.log("Camera deactivated")}catch(e){console.error("Failed to stop camera:",e)}})():await(async()=>{try{if(!confirm("📹 Camera Permission Setup\n\n🔒 Your privacy is protected - no video is recorded or transmitted, and images are only used for one-time analysis.\nContinue? (Cancel for timer-only mode)"))return await i.ChromeStorageService.updateSettings({cameraEnabled:!1,metricsOnly:!0}),void g(e=>({...e,cameraEnabled:!1,isFeatureRestricted:!0}));(await chrome.runtime.getContexts({})).find(e=>"OFFSCREEN_DOCUMENT"===e.contextType)||await chrome.offscreen.createDocument({url:"offscreen.html",reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Camera access for eye health monitoring"});const e=await new Promise((e,t)=>{chrome.runtime.sendMessage({type:"REQUEST_CAMERA"},r=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):r?e(r):t(new Error("No response received from offscreen document"))})});if(e.success)await i.ChromeStorageService.updateSettings({cameraEnabled:!0,metricsOnly:!1}),window.eyeZenCameraStream=!0,g(e=>({...e,cameraEnabled:!0,showCameraPermissionPopup:!1,isFeatureRestricted:!1})),console.log("Camera activated successfully"),alert(" Success! Camera is now active and AI eye health monitoring is running.");else{console.warn("Camera access denied:",e.error),await i.ChromeStorageService.updateSettings({cameraEnabled:!1,metricsOnly:!0}),window.eyeZenCameraStream=null,g(e=>({...e,cameraEnabled:!1,showCameraPermissionPopup:!1,isFeatureRestricted:!0}));const t=`${e.error||"Camera access was denied."}\n\n🔧 **Why "Ask" doesn't work:**\nChrome extension popups close when permission dialogs appear, preventing you from clicking "Allow".\n\n**Solution - Set to "Always Allow":**\n\n**Method 1 - Chrome Address Bar:**\n1. Look for the camera icon (🎥) in Chrome's address bar\n2. Click it and select "Always allow"\n3. Refresh this extension\n\n**Method 2 - Chrome Settings:**\n1. Chrome Settings → Privacy and Security → Site Settings\n2. Click "Camera" → find this extension\n3. Change from "Ask" to "Allow"\n4. Refresh this extension\n\n✅ You can still use basic timer reminders without camera access.`;alert(t)}}catch(e){console.error("Failed to request camera access:",e),alert("Failed to request camera access. Please try again.")}})()}catch(e){console.error("Failed to toggle camera:",e)}},className:"relative inline-flex h-6 w-11 items-center rounded-full transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-white/50 "+(l.cameraEnabled?"bg-green-500 shadow-lg":"bg-white/30"),children:(0,n.jsx)("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 shadow-md "+(l.cameraEnabled?"translate-x-6":"translate-x-1")})})]})})]}),(0,n.jsx)("div",{className:"p-3 relative",children:(0,n.jsx)("div",{className:"text-center mb-3",children:(0,n.jsxs)("div",{className:"bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-3 mx-1 mb-2 border border-gray-100 shadow-sm",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{className:"text-lg mr-2",children:l.eyeScore.current>=80?"😊":l.eyeScore.current>=60?"😐":l.eyeScore.current>=40?"😟":"😵"}),(0,n.jsx)("h2",{className:"text-sm font-semibold text-gray-800",children:"Eye Health Score"})]}),(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("span",{className:`text-xl font-bold ${x(l.eyeScore.current)}`,children:l.eyeScore.current}),(0,n.jsx)("span",{className:"text-sm text-gray-500 ml-1",children:"/100"}),l.cameraEnabled&&50===l.eyeScore.current&&(0,n.jsxs)("span",{className:"ml-2 text-xs text-blue-600 font-medium flex items-center",children:[(0,n.jsx)("span",{className:"animate-spin mr-1",children:"🔄"}),"Analyzing..."]})]})]}),(0,n.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-1.5 mb-2",children:(0,n.jsx)("div",{className:"h-1.5 rounded-full transition-all duration-500 "+(x(l.eyeScore.current).includes("green")?"bg-green-500":x(l.eyeScore.current).includes("yellow")?"bg-yellow-500":"bg-red-500"),style:{width:`${l.eyeScore.current}%`}})}),(0,n.jsx)("div",{className:"text-xs text-gray-500 text-center mb-2",children:"Based on eye strain, posture, fatigue levels"}),(0,n.jsx)("div",{className:"mt-3",children:(0,n.jsx)("button",{onClick:async()=>{try{g(e=>({...e,aiLoading:!0}));const e=l.eyeScore.current||50,t=l.realtimeScore||50,r={blinkRate:15,fatigueIndex:t/100,posture:"good",earValue:.25,perclosValue:.2,timestamp:Date.now()},n=await u.generateHealthSuggestion(e,t,r);g(e=>({...e,aiRecommendation:n.message,aiCategory:n.category,aiLoading:!1})),alert(`AI Health Suggestion (${n.category}):\n\n${n.message}`)}catch(e){console.error("Failed to generate AI recommendation:",e),g(e=>({...e,aiLoading:!1})),alert("Sorry, AI recommendations are not available right now. Please try again later.")}},disabled:l.aiLoading,className:"w-full px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-lg hover:from-green-400 hover:to-emerald-400 transition-all duration-200 font-medium flex items-center justify-center space-x-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:l.aiLoading?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"}),(0,n.jsx)("span",{children:"Getting AI Suggestions..."})]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{children:"🤖"}),(0,n.jsx)("span",{children:"Get AI Health Suggestions"})]})})})]})})}),(0,n.jsxs)("div",{className:"px-4 pb-4 flex-1 overflow-y-auto",children:[(0,n.jsxs)("div",{className:"mb-2",children:[(0,n.jsx)("h3",{className:"text-xs font-medium text-gray-600 mb-1",children:"Choose Your Break"}),(0,n.jsxs)("div",{className:"grid grid-cols-3 gap-1",children:[(0,n.jsxs)("button",{onClick:()=>v(s.BreakType.MICRO),className:"flex flex-col items-center p-2 bg-gradient-to-br from-yellow-300 to-orange-400 hover:from-yellow-400 hover:to-orange-500 rounded border border-orange-300 transition-all duration-200 hover:shadow-md text-white",children:[(0,n.jsx)("span",{className:"text-lg mb-1",children:"⚡"}),(0,n.jsx)("span",{className:"text-xs font-medium text-white",children:"Quick"}),(0,n.jsx)("span",{className:"text-xs text-white opacity-90",children:"20 sec"})]}),(0,n.jsxs)("button",{onClick:()=>v(s.BreakType.SHORT),className:"flex flex-col items-center p-2 bg-gradient-to-br from-green-400 to-emerald-500 hover:from-green-500 hover:to-emerald-600 rounded border border-emerald-400 transition-all duration-200 hover:shadow-md text-white",children:[(0,n.jsx)("span",{className:"text-lg mb-1",children:"👁️"}),(0,n.jsx)("span",{className:"text-xs font-medium text-white",children:"Eye Break"}),(0,n.jsx)("span",{className:"text-xs text-white opacity-90",children:"5 min"})]}),(0,n.jsxs)("button",{onClick:()=>v(s.BreakType.LONG),className:"flex flex-col items-center p-2 bg-gradient-to-br from-purple-400 to-indigo-500 hover:from-purple-500 hover:to-indigo-600 rounded border border-indigo-400 transition-all duration-200 hover:shadow-md text-white",children:[(0,n.jsx)("span",{className:"text-lg mb-1",children:"🧘"}),(0,n.jsx)("span",{className:"text-xs font-medium text-white",children:"Wellness"}),(0,n.jsx)("span",{className:"text-xs text-white opacity-90",children:"15 min"})]})]})]}),(0,n.jsxs)("button",{onClick:()=>{l.isLoggedIn?t():g(e=>({...e,showLoginModal:!0}))},className:"w-full mt-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors flex items-center justify-center space-x-2",children:[!l.isLoggedIn&&(0,n.jsx)("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})}),(0,n.jsx)("span",{children:l.isLoggedIn?"View detailed dashboard →":"Login to view dashboard →"})]})]}),(0,n.jsx)(o.Suspense,{fallback:(0,n.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,n.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-white"})}),children:(0,n.jsx)(m,{isOpen:l.isModalOpen,breakType:l.selectedBreakType,onClose:()=>{g(e=>({...e,isModalOpen:!1,selectedBreakType:null}))},onStartBreak:e})})]})]})};document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("popup-root");e?(0,a.createRoot)(e).render((0,n.jsx)(g,{onStartBreak:e=>{chrome.runtime.sendMessage({action:"START_BREAK",breakType:e},e=>{e?.success?window.close():console.error("Failed to start break:",e?.error)})},onOpenSettings:()=>{chrome.runtime.openOptionsPage(),window.close()}})):console.error("Popup root element not found")}),window.addEventListener("error",e=>{console.error("Popup error:",e.error)}),window.addEventListener("unhandledrejection",e=>{console.error("Popup unhandled promise rejection:",e.reason)})},463:(e,t)=>{function r(e,t){var r=e.length;e.push(t);e:for(;0<r;){var n=r-1>>>1,a=e[n];if(!(0<o(a,t)))break e;e[n]=t,e[r]=a,r=n}}function n(e){return 0===e.length?null:e[0]}function a(e){if(0===e.length)return null;var t=e[0],r=e.pop();if(r!==t){e[0]=r;e:for(var n=0,a=e.length,s=a>>>1;n<s;){var i=2*(n+1)-1,l=e[i],c=i+1,d=e[c];if(0>o(l,r))c<a&&0>o(d,l)?(e[n]=d,e[c]=r,n=c):(e[n]=l,e[i]=r,n=i);else{if(!(c<a&&0>o(d,r)))break e;e[n]=d,e[c]=r,n=c}}}return t}function o(e,t){var r=e.sortIndex-t.sortIndex;return 0!==r?r:e.id-t.id}if("object"==typeof performance&&"function"==typeof performance.now){var s=performance;t.unstable_now=function(){return s.now()}}else{var i=Date,l=i.now();t.unstable_now=function(){return i.now()-l}}var c=[],d=[],m=1,u=null,h=3,g=!1,p=!1,f=!1,y="function"==typeof setTimeout?setTimeout:null,w="function"==typeof clearTimeout?clearTimeout:null,b="undefined"!=typeof setImmediate?setImmediate:null;function x(e){for(var t=n(d);null!==t;){if(null===t.callback)a(d);else{if(!(t.startTime<=e))break;a(d),t.sortIndex=t.expirationTime,r(c,t)}t=n(d)}}function v(e){if(f=!1,x(e),!p)if(null!==n(c))p=!0,T(S);else{var t=n(d);null!==t&&M(v,t.startTime-e)}}function S(e,r){p=!1,f&&(f=!1,w(j),j=-1),g=!0;var o=h;try{for(x(r),u=n(c);null!==u&&(!(u.expirationTime>r)||e&&!N());){var s=u.callback;if("function"==typeof s){u.callback=null,h=u.priorityLevel;var i=s(u.expirationTime<=r);r=t.unstable_now(),"function"==typeof i?u.callback=i:u===n(c)&&a(c),x(r)}else a(c);u=n(c)}if(null!==u)var l=!0;else{var m=n(d);null!==m&&M(v,m.startTime-r),l=!1}return l}finally{u=null,h=o,g=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var C,k=!1,P=null,j=-1,E=5,I=-1;function N(){return!(t.unstable_now()-I<E)}function L(){if(null!==P){var e=t.unstable_now();I=e;var r=!0;try{r=P(!0,e)}finally{r?C():(k=!1,P=null)}}else k=!1}if("function"==typeof b)C=function(){b(L)};else if("undefined"!=typeof MessageChannel){var _=new MessageChannel,A=_.port2;_.port1.onmessage=L,C=function(){A.postMessage(null)}}else C=function(){y(L,0)};function T(e){P=e,k||(k=!0,C())}function M(e,r){j=y(function(){e(t.unstable_now())},r)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(e){e.callback=null},t.unstable_continueExecution=function(){p||g||(p=!0,T(S))},t.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):E=0<e?Math.floor(1e3/e):5},t.unstable_getCurrentPriorityLevel=function(){return h},t.unstable_getFirstCallbackNode=function(){return n(c)},t.unstable_next=function(e){switch(h){case 1:case 2:case 3:var t=3;break;default:t=h}var r=h;h=t;try{return e()}finally{h=r}},t.unstable_pauseExecution=function(){},t.unstable_requestPaint=function(){},t.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var r=h;h=e;try{return t()}finally{h=r}},t.unstable_scheduleCallback=function(e,a,o){var s=t.unstable_now();switch(o="object"==typeof o&&null!==o&&"number"==typeof(o=o.delay)&&0<o?s+o:s,e){case 1:var i=-1;break;case 2:i=250;break;case 5:i=1073741823;break;case 4:i=1e4;break;default:i=5e3}return e={id:m++,callback:a,priorityLevel:e,startTime:o,expirationTime:i=o+i,sortIndex:-1},o>s?(e.sortIndex=o,r(d,e),null===n(c)&&e===n(d)&&(f?(w(j),j=-1):f=!0,M(v,o-s))):(e.sortIndex=i,r(c,e),p||g||(p=!0,T(S))),e},t.unstable_shouldYield=N,t.unstable_wrapCallback=function(e){var t=h;return function(){var r=h;h=t;try{return e.apply(this,arguments)}finally{h=r}}}},982:(e,t,r)=>{e.exports=r(463)}},a={};function o(e){var t=a[e];if(void 0!==t)return t.exports;var r=a[e]={exports:{}};return n[e](r,r.exports,o),r.exports}o.m=n,e=[],o.O=(t,r,n,a)=>{if(!r){var s=1/0;for(d=0;d<e.length;d++){for(var[r,n,a]=e[d],i=!0,l=0;l<r.length;l++)(!1&a||s>=a)&&Object.keys(o.O).every(e=>o.O[e](r[l]))?r.splice(l--,1):(i=!1,a<s&&(s=a));if(i){e.splice(d--,1);var c=n();void 0!==c&&(t=c)}}return t}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[r,n,a]},o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.f={},o.e=e=>Promise.all(Object.keys(o.f).reduce((t,r)=>(o.f[r](e,t),t),[])),o.u=e=>e+".js",o.miniCssF=e=>{},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},r="eyezen-chrome-extension:",o.l=(e,n,a,s)=>{if(t[e])t[e].push(n);else{var i,l;if(void 0!==a)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var m=c[d];if(m.getAttribute("src")==e||m.getAttribute("data-webpack")==r+a){i=m;break}}i||(l=!0,(i=document.createElement("script")).charset="utf-8",i.timeout=120,o.nc&&i.setAttribute("nonce",o.nc),i.setAttribute("data-webpack",r+a),i.src=e),t[e]=[n];var u=(r,n)=>{i.onerror=i.onload=null,clearTimeout(h);var a=t[e];if(delete t[e],i.parentNode&&i.parentNode.removeChild(i),a&&a.forEach(e=>e(n)),r)return r(n)},h=setTimeout(u.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=u.bind(null,i.onerror),i.onload=u.bind(null,i.onload),l&&document.head.appendChild(i)}},o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;o.g.importScripts&&(e=o.g.location+"");var t=o.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var n=r.length-1;n>-1&&(!e||!/^http(s?):/.test(e));)e=r[n--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),o.p=e})(),(()=>{var e={887:0,820:0};o.f.j=(t,r)=>{var n=o.o(e,t)?e[t]:void 0;if(0!==n)if(n)r.push(n[2]);else if(820!=t){var a=new Promise((r,a)=>n=e[t]=[r,a]);r.push(n[2]=a);var s=o.p+o.u(t),i=new Error;o.l(s,r=>{if(o.o(e,t)&&(0!==(n=e[t])&&(e[t]=void 0),n)){var a=r&&("load"===r.type?"missing":r.type),s=r&&r.target&&r.target.src;i.message="Loading chunk "+t+" failed.\n("+a+": "+s+")",i.name="ChunkLoadError",i.type=a,i.request=s,n[1](i)}},"chunk-"+t,t)}else e[t]=0},o.O.j=t=>0===e[t];var t=(t,r)=>{var n,a,[s,i,l]=r,c=0;if(s.some(t=>0!==e[t])){for(n in i)o.o(i,n)&&(o.m[n]=i[n]);if(l)var d=l(o)}for(t&&t(r);c<s.length;c++)a=s[c],o.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return o.O(d)},r=self.webpackChunkeyezen_chrome_extension=self.webpackChunkeyezen_chrome_extension||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var s=o.O(void 0,[644,123,820],()=>o(455));s=o.O(s)})();