<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Improved Eye Health Scoring</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .score {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .score.excellent { color: #10b981; }
        .score.good { color: #3b82f6; }
        .score.fair { color: #f59e0b; }
        .score.poor { color: #ef4444; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .metric {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 6px;
        }
        .metric-label {
            font-weight: 600;
            color: #374151;
        }
        .metric-value {
            font-size: 1.2em;
            color: #1f2937;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test Improved Eye Health Scoring System</h1>
    
    <div class="test-container">
        <h2>Test Scenarios</h2>
        <button onclick="testExcellentHealth()">Test Excellent Health (Should be 85-95+)</button>
        <button onclick="testGoodHealth()">Test Good Health (Should be 70-85)</button>
        <button onclick="testFairHealth()">Test Fair Health (Should be 50-70)</button>
        <button onclick="testPoorHealth()">Test Poor Health (Should be 20-50)</button>
        <button onclick="testCurrentValues()">Test Current Real Values</button>
    </div>

    <div class="test-container" id="results">
        <h2>Test Results</h2>
        <div id="score-display">Click a test button to see results</div>
        <div class="metrics" id="metrics-display"></div>
        <div id="components-display"></div>
    </div>

    <script>
        // Inline EyeHealthScorer implementation with updated thresholds
        class EyeHealthScorer {
            // Updated weights to match new scoring system (blink rate disabled)
            static WEIGHTS = {
                EAR: 0.30,        // Increased from 0.25
                PERCLOS: 0.35,    // Increased from 0.30
                BLINK_RATE: 0.00, // Disabled for real-time scoring
                POSTURE: 0.25,    // Increased from 0.15
                FATIGUE: 0.10
            };

            static THRESHOLDS = {
                EAR: {
                    EXCELLENT: 0.25,  // Updated threshold
                    GOOD: 0.20,
                    FAIR: 0.15,
                    POOR: 0.10
                },
                PERCLOS: {
                    EXCELLENT: 0.15,  // Updated threshold
                    GOOD: 0.25,
                    FAIR: 0.35,
                    POOR: 0.50
                },
                BLINK_RATE: {
                    EXCELLENT: { min: 15, max: 20 },
                    GOOD: { min: 12, max: 25 },
                    FAIR: { min: 8, max: 30 },
                    POOR: { min: 0, max: 50 }
                }
            };

            static calculateScore(metrics) {
                if (!metrics || metrics.length === 0) {
                    return { overall: 0, components: {} };
                }

                const averages = this.calculateAverages(metrics);
                
                const eyeStrain = this.calculateEyeStrainScore(averages.earValue, averages.perclosValue);
                const blinkHealth = this.calculateBlinkHealthScore(averages.blinkRate);
                const postureHealth = this.calculatePostureScore(averages.posture);
                const fatigueLevel = 100 - averages.fatigueIndex; // Invert fatigue

                const overall = Math.round(
                    eyeStrain * (this.WEIGHTS.EAR + this.WEIGHTS.PERCLOS) +
                    // blinkHealth * this.WEIGHTS.BLINK_RATE + // Disabled for real-time scoring
                    postureHealth * this.WEIGHTS.POSTURE +
                    fatigueLevel * this.WEIGHTS.FATIGUE
                );

                return {
                    overall: Math.max(0, Math.min(100, overall)),
                    components: {
                        eyeStrain: Math.round(eyeStrain),
                        blinkHealth: Math.round(blinkHealth),
                        postureHealth: Math.round(postureHealth),
                        fatigueLevel: Math.round(fatigueLevel)
                    }
                };
            }

            static calculateAverages(metrics) {
                const sum = metrics.reduce((acc, metric) => {
                    acc.earValue += metric.earValue || 0;
                    acc.perclosValue += metric.perclosValue || 0;
                    acc.blinkRate += metric.blinkRate || 0;
                    acc.fatigueIndex += metric.fatigueIndex || 0;
                    return acc;
                }, { earValue: 0, perclosValue: 0, blinkRate: 0, fatigueIndex: 0 });

                const count = metrics.length;
                const postures = metrics.map(m => m.posture).filter(p => p);
                const avgPosture = postures.length > 0 ? postures[Math.floor(postures.length / 2)] : 'good';

                return {
                    earValue: sum.earValue / count,
                    perclosValue: sum.perclosValue / count,
                    blinkRate: sum.blinkRate / count,
                    fatigueIndex: sum.fatigueIndex / count,
                    posture: avgPosture
                };
            }

            static calculateEyeStrainScore(earValue, perclosValue) {
                const earScore = this.scoreByThreshold(earValue, this.THRESHOLDS.EAR, true);
                const perclosScore = this.scoreByThreshold(perclosValue, this.THRESHOLDS.PERCLOS, false);
                return (earScore + perclosScore) / 2;
            }

            static calculateBlinkHealthScore(blinkRate) {
                const thresholds = this.THRESHOLDS.BLINK_RATE;
                
                if (blinkRate >= thresholds.EXCELLENT.min && blinkRate <= thresholds.EXCELLENT.max) {
                    return 95;
                } else if (blinkRate >= thresholds.GOOD.min && blinkRate <= thresholds.GOOD.max) {
                    return 80;
                } else if (blinkRate >= thresholds.FAIR.min && blinkRate <= thresholds.FAIR.max) {
                    return 60;
                } else {
                    return 30;
                }
            }

            static calculatePostureScore(posture) {
                const postureScores = {
                    'excellent': 95,
                    'good': 85,
                    'fair': 65,
                    'forward': 45,
                    'tilted': 40,
                    'poor': 25,
                    'very_poor': 15
                };
                return postureScores[posture] || 50;
            }

            static scoreByThreshold(value, thresholds, higherIsBetter) {
                if (higherIsBetter) {
                    if (value >= thresholds.EXCELLENT) return 95;
                    if (value >= thresholds.GOOD) return 80;
                    if (value >= thresholds.FAIR) return 60;
                    return 30;
                } else {
                    if (value <= thresholds.EXCELLENT) return 95;
                    if (value <= thresholds.GOOD) return 80;
                    if (value <= thresholds.FAIR) return 60;
                    return 30;
                }
            }
        }

        // Test functions
        window.testExcellentHealth = function() {
            const metrics = [
                {
                    earValue: 0.30,      // Excellent EAR
                    perclosValue: 0.08,  // Excellent PERCLOS
                    blinkRate: 17,       // Excellent blink rate
                    posture: 'good',     // Good posture
                    fatigueIndex: 15,    // Low fatigue
                    timestamp: Date.now()
                },
                {
                    earValue: 0.31,
                    perclosValue: 0.09,
                    blinkRate: 18,
                    posture: 'excellent',
                    fatigueIndex: 12,
                    timestamp: Date.now()
                },
                {
                    earValue: 0.29,
                    perclosValue: 0.07,
                    blinkRate: 16,
                    posture: 'good',
                    fatigueIndex: 18,
                    timestamp: Date.now()
                }
            ];
            
            testScoring('Excellent Health', metrics);
        };

        window.testGoodHealth = function() {
            const metrics = [
                {
                    earValue: 0.26,      // Good EAR
                    perclosValue: 0.12,  // Good PERCLOS
                    blinkRate: 14,       // Good blink rate
                    posture: 'good',     // Good posture
                    fatigueIndex: 25,    // Moderate fatigue
                    timestamp: Date.now()
                }
            ];
            
            testScoring('Good Health', metrics);
        };

        window.testFairHealth = function() {
            const metrics = [
                {
                    earValue: 0.22,      // Fair EAR
                    perclosValue: 0.18,  // Fair PERCLOS
                    blinkRate: 10,       // Fair blink rate
                    posture: 'fair',     // Fair posture
                    fatigueIndex: 40,    // Higher fatigue
                    timestamp: Date.now()
                }
            ];
            
            testScoring('Fair Health', metrics);
        };

        window.testPoorHealth = function() {
            const metrics = [
                {
                    earValue: 0.18,      // Poor EAR
                    perclosValue: 0.28,  // Poor PERCLOS
                    blinkRate: 5,        // Poor blink rate
                    posture: 'poor',     // Poor posture
                    fatigueIndex: 60,    // High fatigue
                    timestamp: Date.now()
                }
            ];
            
            testScoring('Poor Health', metrics);
        };

        window.testCurrentValues = function() {
            // Test with the values that were causing 41 scores
            const metrics = [
                {
                    earValue: 0.25,      // Current typical values
                    perclosValue: 0.30,  // Current typical values
                    blinkRate: 15,       // Normal blink rate
                    posture: 'good',     // Good posture
                    fatigueIndex: 30,    // Moderate fatigue
                    timestamp: Date.now()
                }
            ];
            
            testScoring('Current Real Values (Previously ~41)', metrics);
        };

        function testScoring(testName, metrics) {
            try {
                const result = EyeHealthScorer.calculateScore(metrics);
                
                displayResults(testName, result, metrics);
                
                console.log(`${testName} Test Results:`, {
                    overall: result.overall,
                    components: result.components,
                    metrics: metrics
                });
            } catch (error) {
                console.error('Error testing scoring:', error);
                document.getElementById('score-display').innerHTML = `
                    <div style="color: red;">
                        <h3>Error: ${error.message}</h3>
                        <p>Check console for details</p>
                    </div>
                `;
            }
        }

        function displayResults(testName, result, metrics) {
            const scoreClass = result.overall >= 80 ? 'excellent' : 
                              result.overall >= 60 ? 'good' : 
                              result.overall >= 40 ? 'fair' : 'poor';
            
            document.getElementById('score-display').innerHTML = `
                <h3>${testName}</h3>
                <div class="score ${scoreClass}">${result.overall}/100</div>
                <p><strong>Status:</strong> ${scoreClass.toUpperCase()}</p>
            `;
            
            const avgMetrics = {
                earValue: metrics.reduce((sum, m) => sum + m.earValue, 0) / metrics.length,
                perclosValue: metrics.reduce((sum, m) => sum + m.perclosValue, 0) / metrics.length,
                blinkRate: metrics.reduce((sum, m) => sum + m.blinkRate, 0) / metrics.length,
                fatigueIndex: metrics.reduce((sum, m) => sum + m.fatigueIndex, 0) / metrics.length
            };
            
            document.getElementById('metrics-display').innerHTML = `
                <div class="metric">
                    <div class="metric-label">Average EAR</div>
                    <div class="metric-value">${avgMetrics.earValue.toFixed(3)}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Average PERCLOS</div>
                    <div class="metric-value">${avgMetrics.perclosValue.toFixed(3)}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Average Blink Rate</div>
                    <div class="metric-value">${avgMetrics.blinkRate.toFixed(1)}/min</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Average Fatigue</div>
                    <div class="metric-value">${avgMetrics.fatigueIndex.toFixed(1)}</div>
                </div>
            `;
            
            document.getElementById('components-display').innerHTML = `
                <h4>Component Scores:</h4>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-label">Eye Strain</div>
                        <div class="metric-value">${result.components.eyeStrain}/100</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Blink Health</div>
                        <div class="metric-value">${result.components.blinkHealth}/100</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Posture Health</div>
                        <div class="metric-value">${result.components.postureHealth}/100</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Fatigue Level</div>
                        <div class="metric-value">${result.components.fatigueLevel}/100</div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>