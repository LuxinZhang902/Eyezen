(()=>{"use strict";var e,t,s,i,a={d:(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},r={};a.r(r),a.d(r,{default:()=>h}),function(e){e.GOOD="good",e.FORWARD="forward",e.TILTED="tilted",e.TOO_CLOSE="too_close",e.TOO_FAR="too_far"}(e||(e={})),function(e){e.GOOD="good",e.TIRED="tired",e.CRITICAL="critical"}(t||(t={})),function(e){e.MICRO="micro",e.SHORT="short",e.LONG="long"}(s||(s={})),function(e){e.ZAN_ZHU="zan_zhu",e.SI_BAI="si_bai",e.JING_MING="jing_ming"}(i||(i={})),Error,i.ZAN_ZHU,i.SI_BAI,i.JING_MING;class o{static calculateEAR(e){if(e.length<6)throw new Error("Insufficient eye landmarks for EAR calculation");const[t,s,i,a,r,o]=e;return(this.euclideanDistance(s,o)+this.euclideanDistance(i,r))/(2*this.euclideanDistance(t,a))}static calculateAverageEAR(e,t){return(this.calculateEAR(e)+this.calculateEAR(t))/2}static euclideanDistance(e,t){const s=e.x-t.x,i=e.y-t.y,a=e.z-t.z;return Math.sqrt(s*s+i*i+a*a)}}class n{constructor(e=30,t=.2){this.earHistory=[],this.windowSize=e,this.closureThreshold=t}addEARValue(e){return this.earHistory.push(e),this.earHistory.length>this.windowSize&&this.earHistory.shift(),this.calculatePERCLOS()}calculatePERCLOS(){return 0===this.earHistory.length?0:this.earHistory.filter(e=>e<this.closureThreshold).length/this.earHistory.length*100}reset(){this.earHistory=[]}getWindowSize(){return this.earHistory.length}}class l{constructor(e=.2,t=100,s=400){this.earHistory=[],this.blinkTimestamps=[],this.startTime=0,this.isInBlink=!1,this.blinkStartTime=0,this.blinkThreshold=e,this.minBlinkDuration=t,this.maxBlinkDuration=s,this.startTime=Date.now()}processEAR(e,t){this.earHistory.push({value:e,timestamp:t});const s=t-2e3;this.earHistory=this.earHistory.filter(e=>e.timestamp>s);const i=t-6e4;return this.blinkTimestamps=this.blinkTimestamps.filter(e=>e>i),!!this.detectBlinkTransition(e,t)&&(this.blinkTimestamps.push(t),console.log("üîç Blink detected! Total blinks in last minute:",this.blinkTimestamps.length),!0)}getBlinkRate(e=6e4){const t=Date.now(),s=t-e,i=this.blinkTimestamps.filter(e=>e>s).length,a=Math.min(e,t-this.startTime);if(a<1e3)return 0;const r=i/a*6e4;return console.log(`üìä Blink rate calculation: ${i} blinks in ${(a/1e3).toFixed(1)}s = ${r.toFixed(1)} bpm`),r}reset(){this.earHistory=[],this.blinkTimestamps=[],this.startTime=Date.now(),this.isInBlink=!1,this.blinkStartTime=0}detectBlinkTransition(e,t){if(!this.isInBlink&&e<=this.blinkThreshold)return this.isInBlink=!0,this.blinkStartTime=t,!1;if(this.isInBlink&&e>this.blinkThreshold){this.isInBlink=!1;const e=t-this.blinkStartTime;if(e>=this.minBlinkDuration&&e<=this.maxBlinkDuration)return!0}return!1}}class c{static estimatePose(e){const t=e[1],s=e[33],i=e[263],a=e[61],r=e[291],o=Math.abs(s.x-i.x),n=(s.x+i.x)/2,l=(t.x-n)/o,c=(s.y+i.y)/2,h=(a.y+r.y)/2,d=Math.abs(h-c),g=(t.y-c)/d,u=(i.y-s.y)/(i.x-s.x),m=Math.atan(u);return{pitch:180*g/Math.PI,yaw:180*l/Math.PI,roll:180*m/Math.PI}}static classifyPosture(t){const{pitch:s,yaw:i,roll:a}=t;return Math.abs(s)>15?s>0?e.FORWARD:e.GOOD:Math.abs(i)>20||Math.abs(a)>15?e.TILTED:e.GOOD}}const h=new class{constructor(){this.faceLandmarker=null,this.isProcessing=!1,this.lastFrameTime=0,this.frameCount=0,this.targetFPS=15,this.frameInterval=1e3/this.targetFPS,this.perclosCalculator=new n(30,.2),this.blinkDetector=new l(.2,100,400),self.addEventListener("message",this.handleMessage.bind(this))}async handleMessage(e){const{type:t,data:s}=e.data;console.log(`üì® CV Worker: Received ${t} message`,s?"with data":"without data"),"process"!==t&&console.log("üîß CV Worker received message:",t,s?"with data":"no data");try{switch(t){case"init":await this.initialize(s);break;case"start":console.log("üöÄ CV Worker: Starting processing"),this.startProcessing();break;case"process":s?(console.log("üéØ CV Worker: Processing frame message received"),await this.processFrame(s)):console.warn("‚ö†Ô∏è CV Worker: Process message received without data");break;case"stop":this.stopProcessing();break;case"cleanup":await this.cleanup();break;default:this.postError(`Unknown message type: ${t}`)}}catch(e){const s=e instanceof Error?e.message:String(e);this.postError(`Error handling ${t}: ${s}`)}}async initialize(e){try{console.log("üöÄ CV Worker: Initializing MediaPipe Face Landmarker..."),await this.loadMediaPipeScripts(),this.faceLandmarker={initialized:!0},console.log("‚úÖ CV Worker: MediaPipe Face Landmarker initialized successfully"),this.postMessage({type:"ready",data:{message:"CV Worker initialized successfully"}})}catch(e){const t=e instanceof Error?e.message:String(e);console.error("‚ùå CV Worker: Failed to initialize MediaPipe:",e),this.postError(`Failed to initialize MediaPipe: ${t}`)}}async loadMediaPipeScripts(){return new Promise(async(e,t)=>{try{console.log("üì¶ CV Worker: Loading MediaPipe scripts..."),importScripts("./assets/mediapipe-worker-loader.js");const{initializeMediaPipe:t,detectForVideo:s}=await globalThis.MediaPipeWorkerLoader.loadVisionTasks();globalThis.detectForVideo=s,console.log("‚úÖ CV Worker: MediaPipe scripts loaded successfully"),e()}catch(e){console.error("‚ùå CV Worker: Failed to load MediaPipe scripts:",e),t(e)}})}async processFrame(e){if(this.faceLandmarker&&this.isProcessing)try{const{imageData:t,timestamp:s}=e;this.frameCount++,console.log(`üîç CV Worker: Processing detection frame ${this.frameCount} at timestamp ${s}`),console.log("üîç CV Worker: detectForVideo available?",typeof globalThis.detectForVideo);const i=new OffscreenCanvas(t.width,t.height),a=i.getContext("2d",{willReadFrequently:!0});if(a.putImageData(t,0,0),"function"!=typeof globalThis.detectForVideo)return void console.error("‚ùå CV Worker: detectForVideo function not available in worker context");console.log("üéØ CV Worker: Calling detectForVideo with canvas:",i.width,"x",i.height);const r=await globalThis.detectForVideo(i,s);if(console.log("üéØ CV Worker: detectForVideo returned:",r),r&&r.faceLandmarks&&r.faceLandmarks.length>0){const e=this.extractMetrics(r.faceLandmarks[0],s);this.frameCount%150==0&&console.log("üëÅÔ∏è CV Worker: Eye metrics calculated:",{blinkRate:e.blinkRate,fatigueIndex:e.fatigueIndex,earValue:e.earValue,perclosValue:e.perclosValue}),this.postMessage({type:"metrics",data:e})}else this.frameCount%300==0&&console.log("üë§ CV Worker: No face detected in frame");a.clearRect(0,0,i.width,i.height),this.lastFrameTime=performance.now()}catch(e){const t=e instanceof Error?e.message:String(e);console.error("‚ùå CV Worker: Frame processing error:",e),this.postError(`Frame processing error: ${t}`)}else console.log("üö´ CV Worker: Skipping frame - faceLandmarker:",!!this.faceLandmarker,"isProcessing:",this.isProcessing)}extractMetrics(e,t){try{const s=this.getEyeLandmarks(e,"left"),i=this.getEyeLandmarks(e,"right"),a=o.calculateAverageEAR(s,i);console.log("üëÅÔ∏è Raw EAR Value:",a.toFixed(3));const r=this.perclosCalculator.addEARValue(a);console.log("üò¥ PERCLOS Value:",r.toFixed(3),"%");const n=this.blinkDetector.processEAR(a,t),l=this.blinkDetector.getBlinkRate();console.log("üëÄ Blink Detection - Is Blinking:",n,"Rate:",l.toFixed(1),"bpm");const h=c.estimatePose(e),d=c.classifyPosture(h);return console.log("üßç Head Pose:",h,"Posture:",d),{blinkRate:l,fatigueIndex:this.calculateFatigueIndex({ear:a,perclos:r,blinkRate:l,posture:d}),posture:d,earValue:a,perclosValue:r,timestamp:t}}catch(e){const t=e instanceof Error?e.message:String(e);throw new Error(`Metrics extraction failed: ${t}`)}}getEyeLandmarks(e,t){const s="left"===t?[33,159,158,133,153,144]:[362,386,385,263,374,373],i=s.map(t=>e[t]).filter(Boolean);return console.log(`üëÅÔ∏è ${t} eye landmarks (${i.length} points):`,i.map((e,t)=>`${s[t]}: (${e.x.toFixed(3)}, ${e.y.toFixed(3)})`)),i}calculateFatigueIndex(t){const{ear:s,perclos:i,blinkRate:a,posture:r}=t;console.log("üîç Fatigue Calculation Input:",{ear:s.toFixed(3),perclos:i.toFixed(3),blinkRate:a.toFixed(1),posture:r});let o=0;const n=Math.max(0,(.3-s)/.3*40);o+=n,console.log("üìä EAR Score:",n.toFixed(1),"(EAR:",s.toFixed(3),"vs normal:",.3,")");const l=Math.min(40,2*i);o+=l,console.log("üìä PERCLOS Score:",l.toFixed(1),"(PERCLOS:",i.toFixed(3),"%)");const c=Math.abs(a-15),h=Math.min(10,c/2);o+=h,console.log("üìä Blink Score:",h.toFixed(1),"(Rate:",a.toFixed(1),"vs normal:",15,")");const d=r===e.GOOD?0:r===e.FORWARD?8:r===e.TILTED?5:10;o+=d,console.log("üìä Posture Score:",d,"(Status:",r,")");const g=Math.min(100,Math.max(0,o));return console.log("üéØ Final Fatigue Index:",g.toFixed(1),"/ 100"),g}startProcessing(){this.isProcessing=!0,this.frameCount=0,this.lastFrameTime=0,this.perclosCalculator.reset(),this.blinkDetector.reset()}stopProcessing(){this.isProcessing=!1,this.postMessage({type:"stopped",data:{frameCount:this.frameCount}})}async cleanup(){this.isProcessing=!1,this.faceLandmarker&&(this.faceLandmarker.close(),this.faceLandmarker=null),this.perclosCalculator.reset(),this.blinkDetector.reset(),this.postMessage({type:"stopped",data:{message:"CV Worker cleaned up"}})}postMessage(e){self.postMessage(e)}postError(e){this.postMessage({type:"error",data:{error:e}})}}})();